<!DOCTYPE html>
<html lang="el">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Î—Î¼ÎµÏÎ¿Î»ÏŒÎ³Î¹Î¿ </title>
    <script src="cordova.js"></script>
    <style>
        :root { --green: #1b5e20; --blue: #0d47a1; --red: #b71c1c; --gold: #fbc02d; --sat-bg: #e3f2fd; --sun-bg: #ffebee; --hol-bg: #ffcdd2; }
        body { font-family: Arial, sans-serif; margin: 0; padding: 5px; background: #f0f0f0; user-select: none; }
        .main-card { max-width: 1100px; margin: auto; background: white; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .header { background: var(--green); color: white; padding: 10px; }
        .top-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .header input, .header select { font-weight: bold; border-radius: 4px; border: none; padding: 10px; width: 100%; font-size: 14px; margin-top: 4px; }
        
        /* Î’Î±ÏƒÎ¹ÎºÎ¬ month-totals (Ï…Ï€Î¬ÏÏ‡Î¿Î½Ï„Î±) */
        .month-totals { 
            display: grid; 
            grid-template-columns: repeat(4, 1fr); 
            gap: 5px; 
            padding: 10px; 
            background: #e8f5e9; 
            border-bottom: 2px solid var(--green); 
        }
        .total-box { 
            background: white; 
            padding: 8px 2px; 
            border-radius: 5px; 
            text-align: center; 
            border: 1px solid #c8e6c9; 
        }
        .total-label { 
            font-size: 9px; 
            font-weight: bold; 
            color: #444; 
            display: block; 
        }
        .total-val { 
            font-size: 14px; 
            font-weight: 900; 
            color: var(--green); 
        }
        
        /* ÎÎ•Î‘ Î Î•Î”Î™Î‘ Î¡Î•Î ÎŸ (2x2 grid - Î”Î™ÎŸÎ¡Î˜Î©ÎœÎ•ÎÎŸ) */
        .rep-container {
            padding: 8px 10px;
            background: #e3f2fd;
            border-bottom: 2px solid #0d47a1;
        }
        
        .rep-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            grid-template-rows: repeat(2, auto);
            gap: 6px;
            margin-bottom: 8px;
        }
        
        .rep-grid-item {
            display: flex;
            flex-direction: column;
        }
        
        .rep-label-small {
            font-size: 9px;
            font-weight: bold;
            color: #0d47a1;
            margin-bottom: 2px;
            display: block;
        }
        
        .rep-input-compact {
            padding: 6px;
            border: 1px solid #90caf9;
            border-radius: 4px;
            background: white;
            font-weight: 900;
            font-size: 13px;
            text-align: center;
            color: #1b5e20;
            width: 100%;
            box-sizing: border-box;
            height: 32px;
        }
        
        .rep-display-compact {
            padding: 6px;
            border: 1px solid #4caf50;
            border-radius: 4px;
            background: white;
            font-weight: 900;
            font-size: 13px;
            text-align: center;
            color: #1b5e20;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .rep-display-transfer {
            border-color: #ff9800;
            color: #ff6f00;
        }
        
        .negative-value {
            color: #f44336 !important;
            border-color: #f44336 !important;
        }
        
        /* ÎšÎ¿Ï…Î¼Ï€Î¹Î¬ ÏƒÎµ Î´Î¹ÎºÎ® Ï„Î¿Ï…Ï‚ Î³ÏÎ±Î¼Î¼Î® */
        .rep-buttons-row {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 6px;
        }
        
        .rep-btn-compact {
            padding: 8px 4px;
            background: #2196f3;
            color: white;
            border: none;
            border-radius: 4px;
            font-weight: bold;
            font-size: 11px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }
        
        .rep-btn-compact:hover {
            background: #1976d2;
        }
        
        .rep-btn-save {
            background: #4caf50;
        }
        
        .rep-btn-clear {
            background: #f44336;
        }
        
        /* Î¥Ï€ÏŒÎ»Î¿Î¹Ï€Î± styles Ï€Î±ÏÎ±Î¼Î­Î½Î¿Ï…Î½ Î¯Î´Î¹Î± */
        .weeks-banner { display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; padding: 10px; background: #fffde7; border-bottom: 3px solid var(--gold); }
        .w-tile { background: white; border: 1px solid #ccc; padding: 5px; border-radius: 5px; text-align: center; font-size: 10px; }
        .w-val { font-weight: 900; font-size: 13px; display: block; }
        table { width: 100%; border-collapse: collapse; table-layout: fixed; }
        td { border: 1px solid #bbb; height: 110px; vertical-align: top; padding: 4px; cursor: pointer; background: white; overflow: hidden; }
        .sat-cell { background: var(--sat-bg) !important; color: var(--blue); }
        .sun-cell { background: var(--sun-bg) !important; color: var(--red); }
        .holiday-cell { background: var(--hol-bg) !important; color: var(--red) !important; border: 2.5px solid var(--red) !important; }
        .day-num { font-weight: 900; font-size: 16px; }
        .shift-tag { background: var(--blue); color: white; font-size: 9px; padding: 2px; border-radius: 3px; display: block; margin-top: 2px; text-align: center; font-weight: bold; }
        .day-note { font-size: 11px; color: #000; font-weight: 900; display: block; margin-top: 4px; border-top: 1px solid #eee; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); }
        .modal-content { background: white; width: 98%; max-width: 550px; margin: 5px auto; padding: 10px; border-radius: 8px; max-height: 95vh; overflow-y: auto; box-sizing: border-box; }
        .m-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 4px; margin-bottom: 10px; }
        .m-btn { padding: 10px 4px; border: 1px solid #ccc; background: #f5f5f5; font-weight: bold; font-size: 11px; display: flex; justify-content: space-between; align-items: center; }
        .shift-row { display: grid; grid-template-columns: 1.8fr 0.8fr 1fr; gap: 4px; margin-bottom: 6px; }
        .shift-row input { width: 100%; padding: 8px 4px; border: 1px solid #ccc; border-radius: 4px; font-weight: bold; font-size: 14px; box-sizing: border-box; }
        .footer { padding: 15px; background: #fafafa; border-top: 4px solid var(--green); }
        .money-line { display: flex; justify-content: space-between; border-bottom: 1px solid #eee; padding: 6px 0; font-size: 14px; font-weight: 900; }
        .backup-btns { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 10px; background: #ddd; }
        .btn-b { padding: 15px 5px; font-size: 12px; font-weight: 900; border-radius: 4px; border: 2px solid #666; background: #fff; color: #000; }
    </style>
</head>
<body>
<div class="main-card">
    <div class="header">
        <div class="top-row"><b>Î—ÎœÎ•Î¡ÎŸÎ›ÎŸÎ“Î™ÎŸ</b>
            <div><button onclick="nav(-1)">â—„</button> <span id="month-label"></span> <button onclick="nav(1)">â–º</button></div>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
            <div><label style="font-size:10px">Î’Î‘Î£Î™ÎšÎŸÎ£</label><input type="number" id="salary" oninput="saveSalary()"></div>
            <div><label style="font-size:10px">Î©Î¡Î‘Î¡Î™ÎŸ</label>
                <select id="mode-sel" onchange="saveMode()">
                    <option value="34">Î©ÏÎ¬ÏÎ¹Î¿ 34h</option>
                    <option value="29">ÎœÎµÎ¹Ï‰Î¼Î­Î½Î¿ 29h</option>
                    <option value="24">ÎœÎµÎ¹Ï‰Î¼Î­Î½Î¿ 24h</option>
                </select>
            </div>
        </div>
    </div>
    
    <!-- Î’Î±ÏƒÎ¹ÎºÎ¬ Î£Î¤ÎŸÎ™Î§Î•Î™Î‘ -->
    <div class="month-totals">
        <div class="total-box"><span class="total-label">Î£Î¤ÎŸÎ§ÎŸÎ£</span><span class="total-val" id="m-target">0.0</span></div>
        <div class="total-box"><span class="total-label">Î¥Î Îš</span><span class="total-val" id="m-upk">0.0</span></div>
        <div class="total-box"><span class="total-label">Î¥Î Î‘</span><span class="total-val" id="m-upa">0.0</span></div>
        <div class="total-box"><span class="total-label">Î Î•Î¡Î‘Î</span><span class="total-val" style="color:#e65100" id="m-peran">0.0</span></div>
    </div>
    
    <!-- ============= ÎÎ•Î‘ Î Î•Î”Î™Î‘ Î¡Î•Î ÎŸ (2x2 GRID) ============= -->
    <div class="rep-container">
        <div class="rep-grid">
            <!-- Î Î»Î·ÏÏ‰Î¼Î­Î½ÎµÏ‚ ÎÏÎµÏ‚ -->
            <div class="rep-grid-item">
                <span class="rep-label-small">Î Î›Î—Î¡Î©ÎœÎ•ÎÎ•Î£</span>
                <input type="number" id="paidHours" class="rep-input-compact" value="0" step="0.5" placeholder="0" onchange="savePaidHours()">
            </div>
            
            <!-- Î£Ï…Î½Î¿Î»Î¹ÎºÏŒ Î¡ÎµÏ€ÏŒ ÎœÎ®Î½Î± (Î£Î¥Î/ÎœÎ—Î) -->
            <div class="rep-grid-item">
                <span class="rep-label-small">Î£Î¥Î/ÎœÎ—Î</span>
                <div id="synminRep" class="rep-display-compact">0</div>
            </div>
            
            <!-- Î ÏÎ¿Î·Î³Î¿ÏÎ¼ÎµÎ½Î¿ Î¡ÎµÏ€ÏŒ (Î Î¡/ÎœÎ—Î) - ÎœÎ• ÎšÎ¡Î¥Î¦ÎŸ INPUT ÎšÎ‘Î™ DISPLAY -->
            <div class="rep-grid-item">
                <span class="rep-label-small">Î Î¡/ÎœÎ—Î</span>
                <!-- ÎšÏÏ…Ï†ÏŒ input Î³Î¹Î± Ï„Î·Î½ Î±ÏÎ¹Î¸Î¼Î·Ï„Î¹ÎºÎ® Ï„Î¹Î¼Î® -->
                <input type="number" id="prminRepRaw" class="rep-input-compact" style="display: none;" step="0.5" onchange="savePrminHours()">
                <!-- Display Ï€Î¿Ï… Î´ÎµÎ¯Ï‡Î½ÎµÎ¹ Ï„Î· Î¼Î¿ÏÏ†Î¿Ï€Î¿Î¹Î·Î¼Î­Î½Î· Ï„Î¹Î¼Î® -->
                <div id="prminRepDisplay" class="rep-display-compact" onclick="editPrminHours()" style="cursor: pointer;">0</div>
            </div>
            
            <!-- Î¥Ï€ÏŒÎ»Î¿Î¹Ï€Î¿ Î³Î¹Î± ÎœÎµÏ„Î±Ï†Î¿ÏÎ¬ (Î Î¡ÎŸÎ¤Î•Î™ÎÎŸÎœÎ•ÎÎŸ) -->
            <div class="rep-grid-item">
                <span class="rep-label-small">ÎœÎ•Î¤Î‘Î¦ÎŸÎ¡Î‘</span>
                <div id="transferRep" class="rep-display-compact rep-display-transfer">0</div>
            </div>
        </div>
        
        <!-- ÎšÎ¿Ï…Î¼Ï€Î¹Î¬ ÏƒÎµ Î¾ÎµÏ‡Ï‰ÏÎ¹ÏƒÏ„Î® Î³ÏÎ±Î¼Î¼Î® -->
        <div class="rep-buttons-row">
            <button class="rep-btn-compact" onclick="calculateRep()">
                ğŸ§® Î¥Ï€Î¿Î».
            </button>
            <button class="rep-btn-compact rep-btn-save" onclick="saveRepTransfer()">
                ğŸ’¾ Î‘Ï€Î¿Î¸.
            </button>
            <button class="rep-btn-compact rep-btn-clear" onclick="clearRepData()">
                ğŸ—‘ï¸ ÎšÎ±Î¸Î±Ï.
            </button>
        </div>
    </div>
    <!-- ============= Î¤Î•Î›ÎŸÎ£ ÎÎ•Î©Î Î Î•Î”Î™Î©Î ============= -->
    
    <div class="weeks-banner" id="weeks-stats"></div>
    <table>
        <thead><tr><th>Î”Î•</th><th>Î¤Î¡</th><th>Î¤Î•</th><th>Î Î•</th><th>Î Î‘</th><th>Î£Î‘</th><th>ÎšÎ¥</th></tr></thead>
        <tbody id="cal-body"></tbody>
    </table>
    
    <div class="backup-btns">
        <button class="btn-b" onclick="exportData()">ğŸ’¾ Î•ÎÎ‘Î“Î©Î“Î— (DOWNLOADS)</button>
        <button class="btn-b" onclick="document.getElementById('importFile').click()">ğŸ“‚ Î•Î™Î£Î‘Î“Î©Î“Î— BACKUP</button>
        <input type="file" id="importFile" style="display:none" accept=".json" onchange="importData(event)">
    </div>

    <div class="footer">
        <div class="money-line" style="background: #fff9c4; padding: 10px; border-radius: 5px; margin-bottom: 10px;">
            Î£Î¥ÎÎŸÎ›ÎŸ Î©Î¡Î©Î: <b id="m-hours" style="font-size: 1.2em; color: var(--blue);">0.0</b>
        </div>
        <div class="money-line">ÎœÎµÎ¹ÎºÏ„Î¬: <b id="r-gross">0.00â‚¬</b></div>
        <div class="money-line">ÎœÎ¤Î Î¥ (2%): <b id="r-mtpy" style="color:var(--red)">0.00â‚¬</b></div>
        <div class="money-line">Î•Î¹ÏƒÏ†Î¿ÏÎ¬ (2%): <b id="r-eis" style="color:var(--red)">0.00â‚¬</b></div>
        <div class="money-line">Î¦ÏŒÏÎ¿Ï‚ (20%): <b id="r-tax" style="color:var(--red)">0.00â‚¬</b></div>
        <div style="background:var(--green); color:white; padding:15px; text-align:center; font-size:2em; font-weight:900; border-radius:8px; margin-top:10px;" id="r-net">0.00â‚¬</div>
    </div>
</div>

<div id="modal" class="modal">
    <div class="modal-content">
        <div class="m-grid" id="m-opts"></div>
        <hr>
        <div class="shift-row"><input type="text" id="c-n1" placeholder="Î’Î¬ÏÎ´Î¹Î± 1"><input type="number" id="c-h1" oninput="recalcMoney(1)"><input type="number" id="c-m1"></div>
        <div class="shift-row"><input type="text" id="c-n2" placeholder="Î’Î¬ÏÎ´Î¹Î± 2"><input type="number" id="c-h2" oninput="recalcMoney(2)"><input type="number" id="c-m2"></div>
        <div id="div-s3" class="shift-row" style="display:none"><input type="text" id="c-n3" placeholder="Î’Î¬ÏÎ´Î¹Î± 3"><input type="number" id="c-h3" oninput="recalcMoney(3)"><input type="number" id="c-m3"></div>
        <button id="btn-add-3" onclick="document.getElementById('div-s3').style.display='grid'; this.style.display='none'" style="width:100%; margin-bottom:5px">+ 3Î· Î’Î¬ÏÎ´Î¹Î±</button>
        <input type="text" id="c-txt" placeholder="Î£Ï‡ÏŒÎ»Î¹Î¿..." style="width:100%; padding:10px; box-sizing:border-box;">
        <button onclick="save()" style="width:100%; padding:15px; background:var(--green); color:white; font-weight:bold; margin-top:10px;">Î‘Î ÎŸÎ˜Î—ÎšÎ•Î¥Î£Î—</button>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px; margin-top:5px">
            <button onclick="del()" style="padding:10px; background:var(--red); color:white;">Î”Î™Î‘Î“Î¡Î‘Î¦Î—</button>
            <button onclick="closeModal()" style="padding:10px;">Î‘ÎšÎ¥Î¡ÎŸ</button>
        </div>
    </div>
</div>

<script>
let cur = new Date(); 
let db = JSON.parse(localStorage.getItem('exfr_db_v53') || '{}');
let settings = JSON.parse(localStorage.getItem('exfr_settings') || '{"mode":"34","salary":1100}');
let activeInput = 'c-n1'; let selD = '';

// Î‘Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ· Î¼ÎµÏ„Î±Ï†Î¿ÏÎ¬Ï‚ ÏÎµÏ€ÏŒ
let repStorage = JSON.parse(localStorage.getItem('exfr_rep_transfer') || '{"savedTransfers": {}}');

// Î›Î±Î¼Î²Î¬Î½ÎµÎ¹ Ï„Î¿ ÎºÎ»ÎµÎ¹Î´Î¯ Î³Î¹Î± Ï„Î¿Î½ Ï„ÏÎ­Ï‡Î¿Î½Ï„Î± Î¼Î®Î½Î± (YYYY-MM)
function getCurrentMonthKey() {
    return `${cur.getFullYear()}-${String(cur.getMonth() + 1).padStart(2, '0')}`;
}

// Î›Î±Î¼Î²Î¬Î½ÎµÎ¹ Ï„Î¿ ÎºÎ»ÎµÎ¹Î´Î¯ Î³Î¹Î± Ï„Î¿Î½ Ï€ÏÎ¿Î·Î³Î¿ÏÎ¼ÎµÎ½Î¿ Î¼Î®Î½Î±
function getPreviousMonthKey() {
    let prevMonth = new Date(cur.getFullYear(), cur.getMonth() - 1, 1);
    return `${prevMonth.getFullYear()}-${String(prevMonth.getMonth() + 1).padStart(2, '0')}`;
}

// ÎÎ­Î± ÏƒÏ…Î½Î¬ÏÏ„Î·ÏƒÎ· Î¼Î¿ÏÏ†Î¿Ï€Î¿Î¯Î·ÏƒÎ·Ï‚ Ï‰ÏÏÎ½ ÏƒÎµ Î·Î¼Î­ÏÎµÏ‚/ÏÏÎµÏ‚
function formatHoursToRep(hours) {
    const HOURS_PER_DAY = 8.5;
    if (!hours || Math.abs(hours) < 0.1) return "0";
    
    const isNegative = hours < 0;
    const absHours = Math.abs(hours);
    const days = Math.floor(absHours / HOURS_PER_DAY);
    const remainingHours = absHours - (days * HOURS_PER_DAY);
    
    let result = isNegative ? "-" : "";
    
    if (days > 0) {
        result += `${days}Ï`;
        if (remainingHours > 0) {
            result += ` ${remainingHours.toFixed(1)}Ï‰`;
        }
    } else {
        result += `${absHours.toFixed(1)}Ï‰`;
    }
    
    return result;
}

// Î•Ï€ÎµÎ¾ÎµÏÎ³Î±ÏƒÎ¯Î± Ï„Î¿Ï… Î Î¡/ÎœÎ—Î
function editPrminHours() {
    const display = document.getElementById('prminRepDisplay');
    const input = document.getElementById('prminRepRaw');
    
    // Î‘Ï€ÏŒÎºÏÏ…ÏˆÎ· display, ÎµÎ¼Ï†Î¬Î½Î¹ÏƒÎ· input
    display.style.display = 'none';
    input.style.display = 'block';
    
    // Focus ÏƒÏ„Î¿ input
    input.focus();
    
    // Î•Ï€Î¹Î»Î¿Î³Î® ÏŒÎ»Î¿Ï… Ï„Î¿Ï… ÎºÎµÎ¹Î¼Î­Î½Î¿Ï…
    input.select();
    
    // Î‘Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ· ÏŒÏ„Î±Î½ Ï‡Î¬ÏƒÎµÎ¹ Ï„Î¿ focus
    input.onblur = function() {
        savePrminHours();
    };
    
    // Î•Ï€Î¯ÏƒÎ·Ï‚ Î¼Îµ Enter
    input.onkeypress = function(e) {
        if (e.key === 'Enter') {
            savePrminHours();
        }
    };
}

// ÎŸÎ¡Î™Î£ÎœÎŸÎ£ Î’Î‘Î¡Î”Î™Î©Î - ÎœÎ• Î¤Î™Î£ ÎÎ•Î•Î£ Î‘Î›Î›Î‘Î“Î•Î£
const SHIFTS = [
    {n:'Î Î¡Î©Î™', h:6, s:0}, {n:'Î‘Î ÎŸÎ“Î•Î¥ÎœÎ‘', h:6, s:0}, {n:'1/2 Î©Î¡Î‘Î£', h:0.5, s:0},
    {n:'ÎÎ¥Î§Î¤Î‘', h:6, s:0.6}, 
    {n:'ÎÎ¥Î§Î¤Î‘ Î‘', h:6, s:0.6},  // Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ· ÎÎ¥Î§Î¤Î‘ Î‘ - Ï€Î»Î·ÏÏÎ½ÎµÏ„Î±Î¹ Î³Î¹Î± 3 ÏÏÎµÏ‚ Î½ÏÏ‡Ï„Î±Ï‚
    {n:'ÎÎ¥Î§Î¤Î‘ Î’', h:6, s:0.6},  // Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ· ÎÎ¥Î§Î¤Î‘ Î’ - Ï€Î»Î·ÏÏÎ½ÎµÏ„Î±Î¹ Î³Î¹Î± 5 ÏÏÎµÏ‚ Î½ÏÏ‡Ï„Î±Ï‚
    {n:'Î‘Î¡Î“Î™Î‘', h:6, s:0.75}, {n:'Î Î•Î¡Î‘Î 5Î—Îœ', h:6, s:1.25},
    {n:'Î Î•Î¡.Î‘Î¡Î“.Î Î¡Î©Î™', h:6, s:1.4}, {n:'Î Î•Î¡.Î‘Î¡Î“.ÎÎ¥Î§Î¤', h:6, s:1.45},
    {n:'Î¥Î Î•Î¡.Î Î¡Î©Î™ (Î Î™ÎšÎ•Î¤ÎŸ)', h:1, s:1.0, isOT:true},  // Î”Î¹ÏŒÏÎ¸Ï‰ÏƒÎ· ÏƒÎµ Î Î™ÎšÎ•Î¤ÎŸ
    {n:'Î¥Î Î•Î¡.ÎÎ¥Î§Î¤Î‘', h:1, s:1.3, isOT:true},
    {n:'Î•Î™Î”Î™ÎšÎ— Î‘Î”Î•Î™Î‘', h:6.8, s:0, abs:true}, {n:'Î‘Î™ÎœÎŸÎ”ÎŸÎ¤Î™ÎšÎ—', h:6.8, s:0, abs:true},
    {n:'ÎšÎ‘Î. Î‘Î”Î•Î™Î‘', h:0, s:0, abs:true}, {n:'Î‘ÎÎ‘Î¡Î¡Î©Î¤Î™ÎšÎ—', h:0, s:0, abs:true},
    {n:'Î’Î¡Î‘Î§Î•Î™Î‘', h:0, s:0, abs:true}, {n:'ÎŸÎ¦ Î¡Î•Î ÎŸ', h:8.5, s:0},
    {n:'Î‘Î”Î™Î‘Î˜Î•Î¤ÎŸ', h:0, s:0, abs:true}, {n:'Î¡Î•Î ÎŸ', h:0, s:0}
];

// --- APK BACKUP ENGINE ---
function exportData() {
    const data = JSON.stringify({ db, settings, repStorage });
    const fileName = `exfr_backup_${new Date().getTime()}.json`;

    if (window.cordova && cordova.file) {
        const path = cordova.file.externalRootDirectory + "Download/";
        window.resolveLocalFileSystemURL(path, (dir) => {
            dir.getFile(fileName, { create: true }, (fileEntry) => {
                fileEntry.createWriter((fileWriter) => {
                    fileWriter.onwriteend = () => alert("âœ… Î¤Î¿ Î±ÏÏ‡ÎµÎ¯Î¿ Î±Ï€Î¿Î¸Î·ÎºÎµÏÏ„Î·ÎºÎµ ÏƒÏ„Î¿ Ï†Î¬ÎºÎµÎ»Î¿ Downloads!");
                    fileWriter.onerror = (e) => alert("âŒ Î£Ï†Î¬Î»Î¼Î± ÎµÎ³Î³ÏÎ±Ï†Î®Ï‚: " + e.toString());
                    fileWriter.write(new Blob([data], { type: 'application/json' }));
                });
            });
        }, (err) => alert("âŒ Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎµ Î¿ Ï†Î¬ÎºÎµÎ»Î¿Ï‚ Downloads. Î”ÏÏƒÏ„Îµ Î´Î¹ÎºÎ±Î¹ÏÎ¼Î±Ï„Î± Î±ÏÏ‡ÎµÎ¯Ï‰Î½."));
    } else {
        const blob = new Blob([data], { type: 'application/json' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = fileName;
        a.click();
    }
}

function importData(e) {
    const file = e.target.files[0]; if (!file) return;
    const reader = new FileReader();
    reader.onload = (event) => {
        try {
            const data = JSON.parse(event.target.result);
            if (data.db) {
                db = data.db; 
                settings = data.settings || settings;
                repStorage = data.repStorage || {"savedTransfers": {}};
                
                localStorage.setItem('exfr_db_v53', JSON.stringify(db));
                localStorage.setItem('exfr_settings', JSON.stringify(settings));
                localStorage.setItem('exfr_rep_transfer', JSON.stringify(repStorage));
                
                alert("âœ… Î¤Î¿ Backup Ï†Î¿ÏÏ„ÏÎ¸Î·ÎºÎµ!"); 
                location.reload();
            }
        } catch(err) { alert("âŒ Î¤Î¿ Î±ÏÏ‡ÎµÎ¯Î¿ Î´ÎµÎ½ ÎµÎ¯Î½Î±Î¹ Î­Î³ÎºÏ…ÏÎ¿."); }
    };
    reader.readAsText(file);
}
// --- END BACKUP ENGINE ---

function fmt(d) { return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`; }
function getHols(y) {
    let h = [fmt(new Date(y,0,1)), fmt(new Date(y,0,6)), fmt(new Date(y,2,25)), fmt(new Date(y,4,1)), fmt(new Date(y,7,15)), fmt(new Date(y,9,16)), fmt(new Date(y,9,28)), fmt(new Date(y,11,25)), fmt(new Date(y,11,26))];
    let a=y%19, d_val=(19*a+15)%30, e_val=(2*(y%4)+4*(y%7)+6*d_val+6)%7;
    let p=d_val+e_val+22+13; let m=3, day=p; if(day>31){day-=31; m=4;} if(day>30){day-=30; m=5;}
    let easter = new Date(y, m-1, day);
    const add = (diff) => { let tmp = new Date(easter); tmp.setDate(tmp.getDate() + diff); h.push(fmt(tmp)); };
    add(-48); add(-2); add(-1); add(0); add(1); add(50); return h;
}

function saveSalary() { let monthKey = `sal_${cur.getFullYear()}-${cur.getMonth()}`; db[monthKey] = parseFloat(document.getElementById('salary').value) || 0; localStorage.setItem('exfr_db_v53', JSON.stringify(db)); calculate(); }
function saveMode() { settings.mode = document.getElementById('mode-sel').value; localStorage.setItem('exfr_settings', JSON.stringify(settings)); calculate(); }

// Î£Î©Î£Î¤Î— Î›ÎŸÎ“Î™ÎšÎ— Î¡Î•Î ÎŸ
function savePaidHours() {
    const paidHours = parseFloat(document.getElementById('paidHours').value) || 0;
    const monthKey = `paid_${cur.getFullYear()}-${cur.getMonth()}`;
    db[monthKey] = paidHours;
    localStorage.setItem('exfr_db_v53', JSON.stringify(db));
    
    // Î•Ï€Î±Î½Î±Ï‹Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼ÏŒÏ‚
    calculateRep();
}

// Î‘Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ· Î Î¡/ÎœÎ—Î
function savePrminHours() {
    const input = document.getElementById('prminRepRaw');
    const display = document.getElementById('prminRepDisplay');
    
    const prminHours = parseFloat(input.value) || 0;
    const monthKey = getCurrentMonthKey();
    
    // Î‘Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ· ÏƒÏ„Î¿ repStorage
    repStorage.savedTransfers[monthKey] = prminHours;
    localStorage.setItem('exfr_rep_transfer', JSON.stringify(repStorage));
    
    // Î•Î¼Ï†Î¬Î½Î¹ÏƒÎ· Î¼Î¿ÏÏ†Î¿Ï€Î¿Î¹Î·Î¼Î­Î½Î·Ï‚ Ï„Î¹Î¼Î®Ï‚
    display.textContent = formatHoursToRep(prminHours);
    
    // Î‘Ï€ÏŒÎºÏÏ…ÏˆÎ· input, ÎµÎ¼Ï†Î¬Î½Î¹ÏƒÎ· display
    input.style.display = 'none';
    display.style.display = 'flex';
    
    // Î•Ï€Î±Î½Î±Ï‹Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼ÏŒÏ‚
    calculateRep();
}

function calculateRep() {
    const HOURS_PER_DAY = 8.5;
    const currentMonthKey = getCurrentMonthKey();
    
    // 1. Î Î¬ÏÎµ Ï„Î¹Ï‚ ÏÏÎµÏ‚ Î Î•Î¡Î‘Î Ï„Î¿Ï… Ï„ÏÎ­Ï‡Î¿Î½Ï„Î¿Ï‚ Î¼Î®Î½Î±
    const peranHours = parseFloat(document.getElementById('m-peran').textContent) || 0;
    
    // 2. Î Î¬ÏÎµ Ï„Î¹Ï‚ Ï€Î»Î·ÏÏ‰Î¼Î­Î½ÎµÏ‚ ÏÏÎµÏ‚ Ï„Î¿Ï… Ï„ÏÎ­Ï‡Î¿Î½Ï„Î¿Ï‚ Î¼Î®Î½Î±
    const paidHours = parseFloat(document.getElementById('paidHours').value) || 0;
    
    // 3. Î¥Î ÎŸÎ›ÎŸÎ“Î™Î£ÎœÎŸÎ£ Î£Î¥Î/ÎœÎ—Î
    const synminHours = peranHours - paidHours;
    
    // 4. Î Î¡/ÎœÎ—Î: Î”Î¹Î¬Î²Î±ÏƒÎµ Î±Ï€ÏŒ Ï„Î¿ ÎºÏÏ…Ï†ÏŒ input
    let prminHours = parseFloat(document.getElementById('prminRepRaw').value) || 0;
    
    // 5. Î¥Î ÎŸÎ›ÎŸÎ“Î™Î£ÎœÎŸÎ£ ÎœÎ•Î¤Î‘Î¦ÎŸÎ¡Î‘Î£
    const transferHours = prminHours + synminHours;
    
    // 6. Î•Î½Î·Î¼Î­ÏÏ‰ÏƒÎ· Î£Î¥Î/ÎœÎ—Î
    let synminEl = document.getElementById('synminRep');
    synminEl.textContent = formatHoursToRep(synminHours);
    synminEl.className = synminHours < 0 ? 'rep-display-compact negative-value' : 'rep-display-compact';
    
    // 7. Î•Î½Î·Î¼Î­ÏÏ‰ÏƒÎ· Î Î¡/ÎœÎ—Î display (ÎµÏ†ÏŒÏƒÎ¿Î½ Î´ÎµÎ½ ÎµÎ¯Î½Î±Î¹ ÏƒÎµ Î»ÎµÎ¹Ï„Î¿Ï…ÏÎ³Î¯Î± edit)
    let prminDisplay = document.getElementById('prminRepDisplay');
    let prminInput = document.getElementById('prminRepRaw');
    if (prminInput.style.display !== 'block') {
        prminDisplay.textContent = formatHoursToRep(prminHours);
        prminDisplay.className = prminHours < 0 ? 'rep-display-compact negative-value' : 'rep-display-compact';
    }
    
    // 8. Î•Î½Î·Î¼Î­ÏÏ‰ÏƒÎ· ÎœÎ•Î¤Î‘Î¦ÎŸÎ¡Î‘Î£
    let transferEl = document.getElementById('transferRep');
    transferEl.textContent = formatHoursToRep(transferHours);
    transferEl.className = transferHours < 0 ? 
        'rep-display-compact rep-display-transfer negative-value' : 
        'rep-display-compact rep-display-transfer';
    
    return {
        synminHours,
        prminHours,
        transferHours,
        currentMonthKey
    };
}

function saveRepTransfer() {
    const result = calculateRep();
    
    if (result.transferHours !== undefined) {
        // Î‘Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ· Ï„Î·Ï‚ Î½Î­Î±Ï‚ Î¼ÎµÏ„Î±Ï†Î¿ÏÎ¬Ï‚ Î³Î¹Î± Ï„Î¿Î½ Ï„ÏÎ­Ï‡Î¿Î½Ï„Î± Î¼Î®Î½Î±
        repStorage.savedTransfers[result.currentMonthKey] = result.transferHours;
        
        // Î•Î½Î·Î¼Î­ÏÏ‰ÏƒÎ· Ï„Î¿Ï… Î Î¡/ÎœÎ—Î Î¼Îµ Ï„Î· Î½Î­Î± Ï„Î¹Î¼Î®
        document.getElementById('prminRepRaw').value = result.transferHours;
        document.getElementById('prminRepDisplay').textContent = formatHoursToRep(result.transferHours);
        
        localStorage.setItem('exfr_rep_transfer', JSON.stringify(repStorage));
        
        // Î•Ï€Î±Î½Î±Ï‹Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼ÏŒÏ‚
        calculateRep();
        
        // ÎœÎ®Î½Ï…Î¼Î± ÎµÏ€Î¹Ï„Ï…Ï‡Î¯Î±Ï‚
        showTempMessage(`âœ… Î‘Ï€Î¿Î¸Î·ÎºÎµÏÏ„Î·ÎºÎµ: ${formatHoursToRep(result.transferHours)}`, 2000);
    }
}

function clearRepData() {
    const currentMonthKey = getCurrentMonthKey();
    
    if (confirm("Î•ÎºÎºÎ±Î¸Î¬ÏÎ¹ÏƒÎ· Ï€Î»Î·ÏÏ‰Î¼Î­Î½Ï‰Î½ Ï‰ÏÏÎ½ Ï„ÏÎ­Ï‡Î¿Î½Ï„Î¿Ï‚ Î¼Î®Î½Î±;")) {
        // ÎœÎ·Î´ÎµÎ½Î¹ÏƒÎ¼ÏŒÏ‚ Ï€Î»Î·ÏÏ‰Î¼Î­Î½Ï‰Î½ Ï‰ÏÏÎ½
        document.getElementById('paidHours').value = 0;
        savePaidHours();
        
        // ÎœÎ·Î´ÎµÎ½Î¹ÏƒÎ¼ÏŒÏ‚ Î Î¡/ÎœÎ—Î
        document.getElementById('prminRepRaw').value = 0;
        savePrminHours();
        
        // Î•Ï€Î±Î½Î±Ï‹Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼ÏŒÏ‚
        calculateRep();
        
        showTempMessage("âœ… ÎœÎ·Î´ÎµÎ½Î¯ÏƒÏ„Î·ÎºÎ±Î½ Î¿Î¹ Ï€Î»Î·ÏÏ‰Î¼Î­Î½ÎµÏ‚ ÏÏÎµÏ‚", 2000);
    }
}

function showTempMessage(msg, duration) {
    const transferEl = document.getElementById('transferRep');
    const originalText = transferEl.textContent;
    const originalClass = transferEl.className;
    
    transferEl.textContent = msg;
    transferEl.className = "rep-display-compact";
    transferEl.style.background = "#4caf50";
    transferEl.style.color = "white";
    transferEl.style.borderColor = "#388e3c";
    
    setTimeout(() => {
        transferEl.textContent = originalText;
        transferEl.className = originalClass;
        transferEl.style.background = "";
        transferEl.style.color = "";
        transferEl.style.borderColor = "";
        calculateRep();
    }, duration);
}

// Î¤Î•Î›ÎŸÎ£ Î£Î©Î£Î¤Î—Î£ Î›ÎŸÎ“Î™ÎšÎ—Î£

// Î£Î¥ÎÎ‘Î¡Î¤Î—Î£Î—: Î¥Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼ÏŒÏ‚ Ï€Î»Î·ÏÏ‰Î¼Î®Ï‚ Î³Î¹Î± ÎÎ¥Î§Î¤Î‘ Î‘ ÎºÎ±Î¹ ÎÎ¥Î§Î¤Î‘ Î’
function calculateNightPayment(shiftName, actualHours) {
    const hr = (parseFloat(document.getElementById('salary').value) || 0) / 280;
    
    if (shiftName === 'ÎÎ¥Î§Î¤Î‘ Î‘') {
        // Î Î»Î·ÏÏÎ½ÎµÏ„Î±Î¹ Î¼ÏŒÎ½Î¿ Î³Î¹Î± 3 ÏÏÎµÏ‚ Î½ÏÏ‡Ï„Î±Ï‚
        return 3 * hr * 0.6;
    } else if (shiftName === 'ÎÎ¥Î§Î¤Î‘ Î’') {
        // Î Î»Î·ÏÏÎ½ÎµÏ„Î±Î¹ Î¼ÏŒÎ½Î¿ Î³Î¹Î± 5 ÏÏÎµÏ‚ Î½ÏÏ‡Ï„Î±Ï‚
        return 5 * hr * 0.6;
    }
    
    // Î“Î¹Î± ÎºÎ±Î½Î¿Î½Î¹ÎºÎ® ÎÎ¥Î§Î¤Î‘
    return actualHours * hr * 0.6;
}

// Î£Î¥ÎÎ‘Î¡Î¤Î—Î£Î—: Î¥Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼ÏŒÏ‚ Ï‡ÏÎ·Î¼Î¬Ï„Ï‰Î½ (ÏŒÏ€Ï‰Ï‚ Ï€ÏÎ¹Î½)
function recalcMoney(num) {
    const hr = (parseFloat(document.getElementById('salary').value) || 0) / 280;
    const h = parseFloat(document.getElementById(`c-h${num}`).value) || 0;
    const shiftName = document.getElementById(`c-n${num}`).value;
    
    let payment = 0;
    
    // Î•Î¹Î´Î¹ÎºÎ® Î´Î¹Î±Ï‡ÎµÎ¯ÏÎ¹ÏƒÎ· Î³Î¹Î± ÎÎ¥Î§Î¤Î‘ Î‘ ÎºÎ±Î¹ ÎÎ¥Î§Î¤Î‘ Î’
    if (shiftName === 'ÎÎ¥Î§Î¤Î‘ Î‘') {
        payment = calculateNightPayment('ÎÎ¥Î§Î¤Î‘ Î‘', h);
    } else if (shiftName === 'ÎÎ¥Î§Î¤Î‘ Î’') {
        payment = calculateNightPayment('ÎÎ¥Î§Î¤Î‘ Î’', h);
    } else {
        // ÎšÎ±Î½Î¿Î½Î¹ÎºÏŒÏ‚ Ï…Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼ÏŒÏ‚ Î³Î¹Î± ÏŒÎ»ÎµÏ‚ Ï„Î¹Ï‚ Î¬Î»Î»ÎµÏ‚ Î²Î¬ÏÎ´Î¹ÎµÏ‚
        const mult = parseFloat(document.getElementById(`c-n${num}`).dataset.mult) || 0;
        payment = h * hr * mult;
    }
    
    document.getElementById(`c-m${num}`).value = payment.toFixed(2);
}

function calculate() {
    const y = cur.getFullYear(), m = cur.getMonth(), monthKey = `sal_${y}-${m}`;
    const sal = db[monthKey] || settings.salary, mB = parseFloat(settings.mode), hols = getHols(y);
    document.getElementById('salary').value = sal; document.getElementById('mode-sel').value = settings.mode;
    document.getElementById('month-label').innerText = new Intl.DateTimeFormat('el-GR', { month: 'short', year: 'numeric' }).format(cur).toUpperCase();
    
    // Î¦ÏŒÏÏ„Ï‰ÏƒÎ· Ï€Î»Î·ÏÏ‰Î¼Î­Î½Ï‰Î½ Ï‰ÏÏÎ½ Î³Î¹Î± Î±Ï…Ï„ÏŒÎ½ Ï„Î¿Î½ Î¼Î®Î½Î±
    const paidMonthKey = `paid_${y}-${m}`;
    document.getElementById('paidHours').value = db[paidMonthKey] || 0;
    
    // Î¦ÏŒÏÏ„Ï‰ÏƒÎ· Î Î¡/ÎœÎ—Î Î±Ï€ÏŒ Ï„Î¿ repStorage
    const currentMonthKey = getCurrentMonthKey();
    const previousMonthKey = getPreviousMonthKey();
    
    // Î ÏÏÏ„Î± Î´Î¿ÎºÎ¯Î¼Î±ÏƒÎµ Î½Î± Ï†Î¿ÏÏ„ÏÏƒÎµÎ¹Ï‚ Î±Ï€ÏŒ Ï„Î¿Î½ Ï„ÏÎ­Ï‡Î¿Î½Ï„Î± Î¼Î®Î½Î±
    let prminValue = 0;
    if (repStorage.savedTransfers[currentMonthKey] !== undefined) {
        prminValue = repStorage.savedTransfers[currentMonthKey];
    } 
    // Î‘Î»Î»Î¹ÏÏ‚ Ï†ÏŒÏÏ„Ï‰ÏƒÎµ Î±Ï€ÏŒ Ï„Î¿Î½ Ï€ÏÎ¿Î·Î³Î¿ÏÎ¼ÎµÎ½Î¿ Î¼Î®Î½Î± (Î³Î¹Î± ÏƒÏ…Î¼Î²Î±Ï„ÏŒÏ„Î·Ï„Î±)
    else if (repStorage.savedTransfers[previousMonthKey] !== undefined) {
        prminValue = repStorage.savedTransfers[previousMonthKey];
    }
    
    // ÎŸÏÎ¹ÏƒÎ¼ÏŒÏ‚ Ï„Î¹Î¼ÏÎ½ ÏƒÏ„Î± Ï€ÎµÎ´Î¯Î± Î Î¡/ÎœÎ—Î
    document.getElementById('prminRepRaw').value = prminValue;
    document.getElementById('prminRepDisplay').textContent = formatHoursToRep(prminValue);
    
    let start = (new Date(y, m, 1).getDay() + 6) % 7, days = new Date(y, m + 1, 0).getDate();
    let tGross = 0, monthT = 0, monthUPK = 0, monthUPA = 0, totalHours = 0;
    let weeks = Array.from({ length: 6 }, () => ({ days: [], target: 0, upk: 0, upa: 0 }));
    
    for (let d = 1; d <= days; d++) {
        let dDate = new Date(y, m, d);
        let dStr = fmt(dDate), wIdx = Math.floor((d + start - 1) / 7);
        weeks[wIdx].days.push({ dStr, isH: hols.includes(dStr), dw: dDate.getDay(), s: db[dStr] });
    }
    
    weeks.forEach(w => {
        if (w.days.length === 0) return;
        let holidayCount = 0;
        let firstDay = new Date(w.days[0].dStr), diff = (firstDay.getDay() + 6) % 7;
        let monday = new Date(firstDay); monday.setDate(firstDay.getDate() - diff);
        
        for (let i = 0; i < 7; i++) {
            let tempD = new Date(monday); tempD.setDate(monday.getDate() + i);
            if (getHols(tempD.getFullYear()).includes(fmt(tempD)) && tempD.getDay() >= 1 && tempD.getDay() <= 5) holidayCount++;
        }
        
        w.target = ( (mB - (holidayCount * (mB / 5))) / 7 ) * (w.days.length - w.days.filter(d => d.s && d.s.abs).length);
        if (w.target < 0) w.target = 0; 
        w.upk = -w.target;
        
        w.days.forEach(day => {
            if (day.s) {
                // ÎŸÎ›Î•Î£ Î¿Î¹ Î²Î¬ÏÎ´Î¹ÎµÏ‚ (ÏƒÏ…Î¼Ï€ÎµÏÎ¹Î»Î±Î¼Î²Î±Î½Î¿Î¼Î­Î½Ï‰Î½ ÎÎ¥Î§Î¤Î‘ Î‘/Î’) Ï€ÏÎ¿ÏƒÎ¸Î­Ï„Î¿Ï…Î½ Ï„Î± Î¼ÎµÎ¹ÎºÏ„Î¬ Ï„Î¿Ï…Ï‚
                tGross += (day.s.m1 || 0) + (day.s.m2 || 0) + (day.s.m3 || 0);
                
                // Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ· Ï‰ÏÏÎ½ ÏƒÏ„Î¿ ÏƒÏÎ½Î¿Î»Î¿
                totalHours += (day.s.h1||0) + (day.s.h2||0) + (day.s.h3||0);
                
                let hc = (day.s.isOT1 ? 0 : (day.s.h1||0)) + (day.s.isOT2 ? 0 : (day.s.h2||0)) + (day.s.isOT3 ? 0 : (day.s.h3||0));
                
                for (let i = 0; i < Math.round(hc * 10); i++) {
                    if (w.upk < -0.01) w.upk += 0.1; 
                    else { 
                        if (day.dw === 0 || day.isH) w.upa += 0.1; 
                        else w.upk += 0.1; 
                    }
                }
            }
        });
        
        monthT += w.target; 
        monthUPK += w.upk; 
        monthUPA += w.upa;
    });
    
    document.getElementById('m-hours').innerText = totalHours.toFixed(1);
    document.getElementById('m-target').innerText = monthT.toFixed(1);
    document.getElementById('m-upk').innerText = monthUPK.toFixed(1);
    document.getElementById('m-upa').innerText = monthUPA.toFixed(1);
    document.getElementById('m-peran').innerText = (monthUPK + monthUPA).toFixed(1);
    
    // Î¥Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼ÏŒÏ‚ Ï„ÎµÎ»Î¹ÎºÏÎ½ Ï€Î¿ÏƒÏÎ½ - Î¤Î©Î¡Î‘ Ï€ÎµÏÎ¹Î»Î±Î¼Î²Î¬Î½ÎµÎ¹ ÎºÎ±Î¹ Ï„Î± Î¼ÎµÎ¹ÎºÏ„Î¬ Î±Ï€ÏŒ ÎÎ¥Î§Î¤Î‘ Î‘/Î’
    let mtpy = tGross * 0.02;
    let eis = tGross * 0.02;
    let tax = (tGross - mtpy - eis) * 0.20;
    let net = tGross - mtpy - eis - tax;
    
    document.getElementById('r-gross').innerText = tGross.toFixed(2) + 'â‚¬';
    document.getElementById('r-mtpy').innerText = mtpy.toFixed(2) + 'â‚¬';
    document.getElementById('r-eis').innerText = eis.toFixed(2) + 'â‚¬';
    document.getElementById('r-tax').innerText = tax.toFixed(2) + 'â‚¬';
    document.getElementById('r-net').innerText = net.toFixed(2) + 'â‚¬';
    
    let body = document.getElementById('cal-body'); 
    body.innerHTML = ''; 
    let row = document.createElement('tr');
    
    for (let i = 0; i < start; i++) row.appendChild(document.createElement('td'));
    
    for (let d = 1; d <= days; d++) {
        if (row.children.length === 7) { 
            body.appendChild(row); 
            row = document.createElement('tr'); 
        }
        
        let dStr = fmt(new Date(y, m, d)), s = db[dStr], isH = hols.includes(dStr), dw = new Date(y, m, d).getDay();
        let cell = document.createElement('td'); 
        cell.onclick = () => openModal(dStr);
        
        if (isH) cell.className = 'holiday-cell'; 
        else if (dw === 0) cell.className = 'sun-cell'; 
        else if (dw === 6) cell.className = 'sat-cell';
        
        let tags = ''; 
        if (s) { 
            if(s.t1) tags+=`<div class="shift-tag">${s.t1}</div>`; 
            if(s.t2) tags+=`<div class="shift-tag">${s.t2}</div>`; 
            if(s.t3) tags+=`<div class="shift-tag">${s.t3}</div>`; 
        }
        
        cell.innerHTML = `<span class="day-num">${d}</span>${tags}${s && s.txt ? `<div class="day-note">${s.txt}</div>` : ''}`;
        row.appendChild(cell);
    }
    
    body.appendChild(row);
    
    const wDiv = document.getElementById('weeks-stats'); 
    wDiv.innerHTML = '';
    
    weeks.forEach((w, i) => { 
        if (w.days.length > 0) {
            wDiv.innerHTML += `
                <div class="w-tile">
                    Î•Î’Î”. ${i+1}<br>
                    Î£Î¤: <span class="w-val">${w.target.toFixed(1)}</span>
                    Î¥Î Îš: <span class="w-val" style="color:var(--blue)">${w.upk.toFixed(1)}</span>
                    Î¥Î Î‘: <span class="w-val" style="color:var(--red)">${w.upa.toFixed(1)}</span>
                </div>
            `;
        }
    });
    
    // Î‘Ï…Ï„ÏŒÎ¼Î±Ï„Î¿Ï‚ Ï…Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼ÏŒÏ‚ ÏÎµÏ€ÏŒ
    calculateRep();
}

function openModal(d) {
    activeInput = 'c-n1'; selD = d; let s = db[d] || {};
    document.getElementById('c-n1').value = s.t1 || ''; document.getElementById('c-h1').value = s.h1 || ''; document.getElementById('c-m1').value = s.m1 || '';
    document.getElementById('c-n2').value = s.t2 || ''; document.getElementById('c-h2').value = s.h2 || ''; document.getElementById('c-m2').value = s.m2 || '';
    document.getElementById('c-n3').value = s.t3 || ''; document.getElementById('c-h3').value = s.h3 || ''; document.getElementById('c-m3').value = s.m3 || '';
    document.getElementById('div-s3').style.display = s.t3 ? 'grid' : 'none';
    document.getElementById('btn-add-3').style.display = s.t3 ? 'none' : 'block';
    document.getElementById('c-txt').value = s.txt || ''; renderShifts();
    document.getElementById('modal').style.display = 'block';
}

function renderShifts() {
    const hr = (parseFloat(document.getElementById('salary').value) || 0) / 280;
    const grid = document.getElementById('m-opts'); grid.innerHTML = '';
    SHIFTS.forEach(o => {
        let b = document.createElement('div'); b.className = 'm-btn';
        
        // Î•Î Î‘ÎÎ‘Î¦ÎŸÎ¡Î‘: Î”ÎµÎ¯Ï‡Î½ÎµÎ¹ Ï„Î¿ Ï‰ÏÎ¿Î¼Î¯ÏƒÎ¸Î¹Î¿ (ÏŒÏ‡Î¹ Ï„Î¿ ÏƒÏ…Î½Î¿Î»Î¹ÎºÏŒ Ï€Î¿ÏƒÏŒ)
        // Î¤Î¿ Ï‰ÏÎ¿Î¼Î¯ÏƒÎ¸Î¹Î¿ ÎµÎ¯Î½Î±Î¹: (Î²Î±ÏƒÎ¹ÎºÏŒÏ‚ Î¼Î¹ÏƒÎ¸ÏŒÏ‚ / 280) * ÏƒÏ…Î½Ï„ÎµÎ»ÎµÏƒÏ„Î®Ï‚ Î²Î¬ÏÎ´Î¹Î±Ï‚
        let hourlyRate = (hr * o.s).toFixed(2);
        
        // Î•Î¹Î´Î¹ÎºÎ® ÎµÏ„Î¹ÎºÎ­Ï„Î± Î³Î¹Î± ÎÎ¥Î§Î¤Î‘ Î‘ ÎºÎ±Î¹ ÎÎ¥Î§Î¤Î‘ Î’
        let displayName = o.n;
        if (o.n === 'ÎÎ¥Î§Î¤Î‘ Î‘') {
            displayName = 'ÎÎ¥Î§Î¤Î‘ Î‘ (3Ï‰ Ï€Î»Î·Ï.)';
        } else if (o.n === 'ÎÎ¥Î§Î¤Î‘ Î’') {
            displayName = 'ÎÎ¥Î§Î¤Î‘ Î’ (5Ï‰ Ï€Î»Î·Ï.)';
        }
        
        b.innerHTML = `<span>${displayName}</span> <span style="color:var(--red)">${hourlyRate > 0 ? hourlyRate + 'â‚¬' : ''}</span>`;
        b.onclick = () => {
            let t = activeInput; 
            let nameInput = document.getElementById(t);
            nameInput.value = o.n; 
            
            // ÎŸÏÎ¹ÏƒÎ¼ÏŒÏ‚ Ï„Ï‰Î½ Ï€ÏÎ¿Ï„ÎµÎ¹Î½ÏŒÎ¼ÎµÎ½Ï‰Î½ Ï‰ÏÏÎ½ (6 Î³Î¹Î± ÏŒÎ»ÎµÏ‚ Ï„Î¹Ï‚ Î²Î¬ÏÎ´Î¹ÎµÏ‚)
            document.getElementById(t.replace('n', 'h')).value = o.h;
            
            nameInput.dataset.mult = o.s;
            nameInput.dataset.isot = o.isOT ? "1" : "0";
            
            recalcMoney(t.slice(-1));
            activeInput = (t === 'c-n1') ? 'c-n2' : (t === 'c-n2' && document.getElementById('div-s3').style.display==='grid' ? 'c-n3' : 'c-n1');
        }; grid.appendChild(b);
    });
}

function save() {
    const hr = (parseFloat(document.getElementById('salary').value) || 0) / 280;
    
    // Î›Î®ÏˆÎ· Ï„Î¹Î¼ÏÎ½ Î±Ï€ÏŒ Ï„Î± Ï€ÎµÎ´Î¯Î± ÎµÎ¹ÏƒÏŒÎ´Î¿Ï…
    const t1 = document.getElementById('c-n1').value;
    const h1 = parseFloat(document.getElementById('c-h1').value) || 0;
    const t2 = document.getElementById('c-n2').value;
    const h2 = parseFloat(document.getElementById('c-h2').value) || 0;
    const t3 = document.getElementById('c-n3').value;
    const h3 = parseFloat(document.getElementById('c-h3').value) || 0;
    const txt = document.getElementById('c-txt').value;
    
    // Î¥Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼ÏŒÏ‚ Ï€Î»Î·ÏÏ‰Î¼Î®Ï‚ Î³Î¹Î± ÎºÎ¬Î¸Îµ Î²Î¬ÏÎ´Î¹Î±
    let m1 = 0, m2 = 0, m3 = 0;
    
    // Î’Î¬ÏÎ´Î¹Î± 1
    if (t1 === 'ÎÎ¥Î§Î¤Î‘ Î‘') {
        m1 = calculateNightPayment('ÎÎ¥Î§Î¤Î‘ Î‘', h1);
    } else if (t1 === 'ÎÎ¥Î§Î¤Î‘ Î’') {
        m1 = calculateNightPayment('ÎÎ¥Î§Î¤Î‘ Î’', h1);
    } else if (t1) {
        const shift1 = SHIFTS.find(s => s.n === t1);
        if (shift1) {
            m1 = h1 * hr * shift1.s;
        }
    }
    
    // Î’Î¬ÏÎ´Î¹Î± 2
    if (t2 === 'ÎÎ¥Î§Î¤Î‘ Î‘') {
        m2 = calculateNightPayment('ÎÎ¥Î§Î¤Î‘ Î‘', h2);
    } else if (t2 === 'ÎÎ¥Î§Î¤Î‘ Î’') {
        m2 = calculateNightPayment('ÎÎ¥Î§Î¤Î‘ Î’', h2);
    } else if (t2) {
        const shift2 = SHIFTS.find(s => s.n === t2);
        if (shift2) {
            m2 = h2 * hr * shift2.s;
        }
    }
    
    // Î’Î¬ÏÎ´Î¹Î± 3
    if (t3 === 'ÎÎ¥Î§Î¤Î‘ Î‘') {
        m3 = calculateNightPayment('ÎÎ¥Î§Î¤Î‘ Î‘', h3);
    } else if (t3 === 'ÎÎ¥Î§Î¤Î‘ Î’') {
        m3 = calculateNightPayment('ÎÎ¥Î§Î¤Î‘ Î’', h3);
    } else if (t3) {
        const shift3 = SHIFTS.find(s => s.n === t3);
        if (shift3) {
            m3 = h3 * hr * shift3.s;
        }
    }
    
    // Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± Î±Î½Ï„Î¹ÎºÎµÎ¹Î¼Î­Î½Î¿Ï… Î²Î¬ÏÎ´Î¹Î±Ï‚
    const s = {
        t1: t1,
        h1: h1,
        m1: parseFloat(m1.toFixed(2)),
        isOT1: SHIFTS.find(x => x.n === t1)?.isOT || false,
        
        t2: t2,
        h2: h2,
        m2: parseFloat(m2.toFixed(2)),
        isOT2: SHIFTS.find(x => x.n === t2)?.isOT || false,
        
        t3: t3,
        h3: h3,
        m3: parseFloat(m3.toFixed(2)),
        isOT3: SHIFTS.find(x => x.n === t3)?.isOT || false,
        
        txt: txt
    };
    
    // ÎˆÎ»ÎµÎ³Ï‡Î¿Ï‚ Î³Î¹Î± Î±Ï€Î¿Ï…ÏƒÎ¯Î±
    const shift1 = SHIFTS.find(x => x.n === s.t1);
    const shift2 = SHIFTS.find(x => x.n === s.t2);
    const shift3 = SHIFTS.find(x => x.n === s.t3);
    
    s.abs = shift1?.abs || shift2?.abs || shift3?.abs || false;
    
    // Î‘Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ· ÏƒÏ„Î· Î²Î¬ÏƒÎ· Î´ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½
    db[selD] = s; 
    localStorage.setItem('exfr_db_v53', JSON.stringify(db)); 
    closeModal(); 
    calculate();
}

function del() { 
    delete db[selD]; 
    localStorage.setItem('exfr_db_v53', JSON.stringify(db)); 
    closeModal(); 
    calculate(); 
}

function closeModal() { 
    document.getElementById('modal').style.display = 'none'; 
    selD = '';  // Î•ÎºÎºÎ±Î¸Î¬ÏÎ¹ÏƒÎ· Ï„Î·Ï‚ ÎµÏ€Î¹Î»ÎµÎ³Î¼Î­Î½Î·Ï‚ Î·Î¼ÎµÏÎ¿Î¼Î·Î½Î¯Î±Ï‚
}

function nav(v) { 
    cur.setMonth(cur.getMonth() + v); 
    calculate(); 
}

// Î‘ÏÏ‡Î¹ÎºÎ¿Ï€Î¿Î¯Î·ÏƒÎ·
document.addEventListener('DOMContentLoaded', function() {
    const savedRep = localStorage.getItem('exfr_rep_transfer');
    if (savedRep) {
        try {
            repStorage = JSON.parse(savedRep);
            if (!repStorage.savedTransfers) {
                repStorage.savedTransfers = {};
            }
        } catch(e) {
            repStorage = {"savedTransfers": {}};
        }
    } else {
        repStorage = {"savedTransfers": {}};
    }
    
    // Î‘Ï…Ï„ÏŒÎ¼Î±Ï„Î¿Ï‚ Ï…Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼ÏŒÏ‚ ÏƒÏ„Î·Î½ Î­Î½Î±ÏÎ¾Î·
    setTimeout(function() {
        calculate();
    }, 100);
});

document.addEventListener('deviceready', calculate, false);
if(!window.cordova) calculate();
</script>
</body>
</html>
