<!DOCTYPE html>
<html lang="el">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Î—Î¼ÎµÏÎ¿Î»ÏŒÎ³Î¹Î¿ ÎÏ…Ï‡Ï„ÎµÏÎ¹Î½ÏÎ½ & Î ÎµÎ½Î¸Î·Î¼Î­ÏÏ‰Î½</title>
    <script src="cordova.js"></script>
    <style>
        :root { --green: #1b5e20; --blue: #0d47a1; --red: #b71c1c; --gold: #fbc02d; --sat-bg: #e3f2fd; --sun-bg: #ffebee; --hol-bg: #ffcdd2; }
        body { font-family: Arial, sans-serif; margin: 0; padding: 5px; background: #f0f0f0; user-select: none; }
        .main-card { max-width: 1100px; margin: auto; background: white; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .header { background: var(--green); color: white; padding: 10px; }
        .top-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .header select { font-weight: bold; border-radius: 4px; border: none; padding: 10px; width: 100%; font-size: 14px; margin-top: 4px; }
        
        .month-totals { 
            display: grid; 
            grid-template-columns: repeat(4, 1fr); 
            gap: 5px; 
            padding: 10px; 
            background: #e8f5e9; 
            border-bottom: 2px solid var(--green); 
        }
        .total-box { 
            background: white; 
            padding: 8px 2px; 
            border-radius: 5px; 
            text-align: center; 
            border: 1px solid #c8e6c9; 
        }
        .total-label { 
            font-size: 9px; 
            font-weight: bold; 
            color: #444; 
            display: block; 
        }
        .total-val { 
            font-size: 14px; 
            font-weight: 900; 
            color: var(--green); 
        }
        
        .rep-container {
            padding: 8px 10px;
            background: #e3f2fd;
            border-bottom: 2px solid #0d47a1;
        }
        
        .rep-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            grid-template-rows: repeat(2, auto);
            gap: 6px;
            margin-bottom: 8px;
        }
        
        .rep-grid-item {
            display: flex;
            flex-direction: column;
        }
        
        .rep-label-small {
            font-size: 9px;
            font-weight: bold;
            color: #0d47a1;
            margin-bottom: 2px;
            display: block;
        }
        
        .rep-input-compact {
            padding: 6px;
            border: 1px solid #90caf9;
            border-radius: 4px;
            background: white;
            font-weight: 900;
            font-size: 13px;
            text-align: center;
            color: #1b5e20;
            width: 100%;
            box-sizing: border-box;
            height: 32px;
        }
        
        .rep-display-compact {
            padding: 6px;
            border: 1px solid #4caf50;
            border-radius: 4px;
            background: white;
            font-weight: 900;
            font-size: 13px;
            text-align: center;
            color: #1b5e20;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .rep-display-transfer {
            border-color: #ff9800;
            color: #ff6f00;
        }
        
        .negative-value {
            color: #f44336 !important;
            border-color: #f44336 !important;
        }
        
        .rep-buttons-row {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 6px;
        }
        
        .rep-btn-compact {
            padding: 8px 4px;
            background: #2196f3;
            color: white;
            border: none;
            border-radius: 4px;
            font-weight: bold;
            font-size: 11px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }
        
        .rep-btn-compact:hover {
            background: #1976d2;
        }
        
        .rep-btn-save {
            background: #4caf50;
        }
        
        .rep-btn-clear {
            background: #f44336;
        }
        
        .weeks-banner { display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; padding: 10px; background: #fffde7; border-bottom: 3px solid var(--gold); }
        .w-tile { background: white; border: 1px solid #ccc; padding: 5px; border-radius: 5px; text-align: center; font-size: 10px; }
        .w-val { font-weight: 900; font-size: 13px; display: block; }
        table { width: 100%; border-collapse: collapse; table-layout: fixed; }
        td { border: 1px solid #bbb; height: 110px; vertical-align: top; padding: 4px; cursor: pointer; background: white; overflow: hidden; }
        .sat-cell { background: var(--sat-bg) !important; color: var(--blue); }
        .sun-cell { background: var(--sun-bg) !important; color: var(--red); }
        .holiday-cell { background: var(--hol-bg) !important; color: var(--red) !important; border: 2.5px solid var(--red) !important; }
        .day-num { font-weight: 900; font-size: 16px; }
        .shift-tag { background: var(--blue); color: white; font-size: 9px; padding: 2px; border-radius: 3px; display: block; margin-top: 2px; text-align: center; font-weight: bold; }
        .day-note { font-size: 11px; color: #000; font-weight: 900; display: block; margin-top: 4px; border-top: 1px solid #eee; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); }
        .modal-content { background: white; width: 98%; max-width: 550px; margin: 5px auto; padding: 10px; border-radius: 8px; max-height: 95vh; overflow-y: auto; box-sizing: border-box; }
        .m-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 4px; margin-bottom: 10px; }
        .m-btn { padding: 10px 4px; border: 1px solid #ccc; background: #f5f5f5; font-weight: bold; font-size: 11px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .m-btn:hover { background: #e0e0e0; }
        .m-btn.selected { background: #4caf50; color: white; border-color: #2e7d32; }
        .shift-row { display: grid; grid-template-columns: 1.8fr 0.8fr 1fr; gap: 4px; margin-bottom: 6px; }
        .shift-row input { width: 100%; padding: 8px 4px; border: 1px solid #ccc; border-radius: 4px; font-weight: bold; font-size: 14px; box-sizing: border-box; }
        .footer { padding: 15px; background: #fafafa; border-top: 4px solid var(--green); }
        .money-line { display: flex; justify-content: space-between; border-bottom: 1px solid #eee; padding: 6px 0; font-size: 14px; font-weight: 900; }
        .backup-btns { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 10px; background: #ddd; }
        .btn-b { padding: 15px 5px; font-size: 12px; font-weight: 900; border-radius: 4px; border: 2px solid #666; background: #fff; color: #000; cursor: pointer; }
        .penthemera-box { 
            background: #fff3e0; 
            padding: 10px; 
            border-radius: 5px; 
            margin: 10px 0;
            border-left: 5px solid #ff9800;
        }
        .penthemera-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        .penthemera-item {
            background: white;
            padding: 8px;
            border-radius: 4px;
            text-align: center;
        }
        .total-net-box {
            background: var(--green);
            color: white;
            padding: 15px;
            text-align: center;
            font-size: 1.8em;
            font-weight: 900;
            border-radius: 8px;
            margin: 10px 0;
        }
        .shift-indicator {
            font-size: 10px;
            color: #666;
            margin-bottom: 5px;
        }
        .active-shift {
            background: #2196f3 !important;
            color: white !important;
        }
    </style>
</head>
<body>
<div class="main-card">
    <div class="header">
        <div class="top-row">
            <b>Î•ÎÎ¦Î¡ - ÎÏ…Ï‡Ï„ÎµÏÎ¹Î½Î¬ & Î ÎµÎ½Î¸Î®Î¼ÎµÏÎ±</b>
            <div>
                <button onclick="nav(-1)">â—„</button> 
                <span id="month-label"></span> 
                <button onclick="nav(1)">â–º</button>
            </div>
        </div>
        <div>
            <label style="font-size:10px">Î©Î¡Î‘Î¡Î™ÎŸ</label>
            <select id="mode-sel" onchange="saveMode()">
                <option value="40">40 ÏÏÎµÏ‚</option>
                <option value="34">34 ÏÏÎµÏ‚</option>
                <option value="32">32 ÏÏÎµÏ‚</option>
            </select>
        </div>
    </div>
    
    <!-- Î’Î±ÏƒÎ¹ÎºÎ¬ Î£Î¤ÎŸÎ™Î§Î•Î™Î‘ -->
    <div class="month-totals">
        <div class="total-box"><span class="total-label">Î£Î¤ÎŸÎ§ÎŸÎ£</span><span class="total-val" id="m-target">0.0</span></div>
        <div class="total-box"><span class="total-label">Î¥Î Îš</span><span class="total-val" id="m-upk">0.0</span></div>
        <div class="total-box"><span class="total-label">Î¥Î Î‘</span><span class="total-val" id="m-upa">0.0</span></div>
        <div class="total-box"><span class="total-label">Î Î•Î¡Î‘Î</span><span class="total-val" style="color:#e65100" id="m-peran">0.0</span></div>
    </div>
    
    <!-- Î Î»Î±Î¯ÏƒÎ¹Î¿ ÎœÎµÎ¹Ï‰Î¼Î­Î½Î¿ ÎºÎ±Î¹ Î¡ÎµÏ€ÏŒ -->
    <div class="rep-container">
        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; margin-bottom: 10px;">
            <div>
                <span class="rep-label-small">ÎœÎ•Î™Î©ÎœÎ•ÎÎŸ</span>
                <select id="reduced-select" class="rep-input-compact" onchange="updateWeeklyHours()">
                    <option value="normal">ÎšÎ±Î½Î¿Î½Î¹ÎºÏŒ</option>
                    <option value="minus1">-1 ÏÏÎ±</option>
                    <option value="minus2">-2 ÏÏÎµÏ‚</option>
                </select>
            </div>
            <div>
                <span class="rep-label-small">Î Î•ÎÎ˜Î—ÎœÎ•Î¡Î‘ ÎœÎ—ÎÎ‘</span>
                <div id="penthemera-count-display" class="rep-display-compact">0</div>
            </div>
        </div>
        
        <!-- Î ÎµÎ´Î¯Î± Î¡Î•Î ÎŸ -->
        <div class="rep-grid">
            <div class="rep-grid-item">
                <span class="rep-label-small">Î Î›Î—Î¡Î©ÎœÎ•ÎÎ•Î£</span>
                <input type="number" id="paidHours" class="rep-input-compact" value="0" step="0.5" placeholder="0" onchange="savePaidHours()">
            </div>
            
            <div class="rep-grid-item">
                <span class="rep-label-small">Î£Î¥Î/ÎœÎ—Î</span>
                <div id="synminRep" class="rep-display-compact">0</div>
            </div>
            
            <div class="rep-grid-item">
                <span class="rep-label-small">Î Î¡/ÎœÎ—Î</span>
                <div id="prminRep" class="rep-display-compact">0</div>
            </div>
            
            <div class="rep-grid-item">
                <span class="rep-label-small">ÎœÎ•Î¤Î‘Î¦ÎŸÎ¡Î‘</span>
                <div id="transferRep" class="rep-display-compact rep-display-transfer">0</div>
            </div>
        </div>
        
        <!-- ÎšÎ¿Ï…Î¼Ï€Î¹Î¬ -->
        <div class="rep-buttons-row">
            <button class="rep-btn-compact" onclick="calculateRep()">
                ğŸ§® Î¥Ï€Î¿Î».
            </button>
            <button class="rep-btn-compact rep-btn-save" onclick="saveRepTransfer()">
                ğŸ’¾ Î‘Ï€Î¿Î¸.
            </button>
            <button class="rep-btn-compact rep-btn-clear" onclick="clearRepData()">
                ğŸ—‘ï¸ ÎšÎ±Î¸Î±Ï.
            </button>
        </div>
    </div>
    
    <!-- Î¥Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼ÏŒÏ‚ Î ÎµÎ½Î¸Î·Î¼Î­ÏÏ‰Î½ (Î±Ï…Ï„ÏŒÎ¼Î±Ï„Î¿Ï‚ Î±Ï€ÏŒ Ï„Î¿ Î·Î¼ÎµÏÎ¿Î»ÏŒÎ³Î¹Î¿) -->
    <div class="penthemera-box">
        <div class="penthemera-grid">
            <div class="penthemera-item">
                <div style="font-size: 11px; font-weight: bold;">Î ÎµÎ½Î¸Î®Î¼ÎµÏÎ±</div>
                <div id="p-count" style="font-size: 16px; font-weight: 900;">0</div>
            </div>
            <div class="penthemera-item">
                <div style="font-size: 11px; font-weight: bold;">ÎœÎµÎ¹ÎºÏ„ÏŒ (46â‚¬/Ï„ÎµÎ¼)</div>
                <div id="p-gross" style="font-size: 16px; font-weight: 900;">0.00â‚¬</div>
            </div>
            <div class="penthemera-item">
                <div style="font-size: 11px; font-weight: bold;">Î•Î¹ÏƒÏ†Î¿ÏÎ¬ 2%</div>
                <div id="p-eis" style="font-size: 14px; color: var(--red);">0.00â‚¬</div>
            </div>
            <div class="penthemera-item">
                <div style="font-size: 11px; font-weight: bold;">Î¦ÏŒÏÎ¿Ï‚ 20%</div>
                <div id="p-tax" style="font-size: 14px; color: var(--red);">0.00â‚¬</div>
            </div>
            <div class="penthemera-item" style="grid-column: span 2; background: #e8f5e9;">
                <div style="font-size: 11px; font-weight: bold;">ÎšÎ‘Î˜Î‘Î¡ÎŸ Î Î•ÎÎ˜Î—ÎœÎ•Î¡Î©Î</div>
                <div id="p-net" style="font-size: 20px; font-weight: 900; color: var(--green);">0.00â‚¬</div>
            </div>
        </div>
    </div>
    
    <div class="weeks-banner" id="weeks-stats"></div>
    
    <table>
        <thead><tr><th>Î”Î•</th><th>Î¤Î¡</th><th>Î¤Î•</th><th>Î Î•</th><th>Î Î‘</th><th>Î£Î‘</th><th>ÎšÎ¥</th></tr></thead>
        <tbody id="cal-body"></tbody>
    </table>
    
    <div class="backup-btns">
        <button class="btn-b" onclick="exportData()">ğŸ’¾ Î•ÎÎ‘Î“Î©Î“Î— (DOWNLOADS)</button>
        <button class="btn-b" onclick="document.getElementById('importFile').click()">ğŸ“‚ Î•Î™Î£Î‘Î“Î©Î“Î— BACKUP</button>
        <input type="file" id="importFile" style="display:none" accept=".json" onchange="importData(event)">
    </div>

    <div class="footer">
        <div class="money-line" style="background: #e1f5fe; padding: 10px; border-radius: 5px; margin-bottom: 10px;">
            <span>Î£Î¥ÎÎŸÎ›ÎŸ ÎÎ¥Î§Î¤Î•Î¡Î™ÎÎ©Î Î©Î¡Î©Î:</span>
            <b id="m-night-hours" style="font-size: 1.2em; color: var(--blue);">0.0</b>
        </div>
        
        <div class="money-line" style="background: #f3e5f5; padding: 10px; border-radius: 5px; margin-bottom: 10px;">
            <span>ÎšÎ‘Î˜Î‘Î¡Î‘ ÎÎ¥Î§Î¤Î•Î¡Î™ÎÎ©Î (3.3â‚¬/ÏÏÎ±):</span>
            <b id="night-net" style="font-size: 1.2em; color: #7b1fa2;">0.00â‚¬</b>
        </div>
        
        <!-- Î£Î¥ÎÎŸÎ›Î™ÎšÎŸ ÎšÎ‘Î˜Î‘Î¡ÎŸ (ÎÏÏ‡Ï„ÎµÏ‚ + Î ÎµÎ½Î¸Î®Î¼ÎµÏÎ±) -->
        <div class="total-net-box" id="total-net">
            0.00â‚¬
        </div>
        
        <div style="font-size: 12px; text-align: center; color: #666; margin-top: 10px;">
            * Î¤Î¿ ÏƒÏÎ½Î¿Î»Î¿ ÎµÎ¯Î½Î±Î¹ Î¬Î¸ÏÎ¿Î¹ÏƒÎ¼Î± ÎºÎ±Î¸Î±ÏÏÎ½ Î½Ï…Ï‡Ï„ÎµÏÎ¹Î½ÏÎ½ (3.3â‚¬/ÏÏÎ±) ÎºÎ±Î¹ ÎºÎ±Î¸Î±ÏÏÎ½ Ï€ÎµÎ½Î¸Î·Î¼Î­ÏÏ‰Î½
        </div>
    </div>
</div>

<div id="modal" class="modal">
    <div class="modal-content">
        <div style="margin-bottom: 10px; font-weight: bold; text-align: center;" id="modal-date"></div>
        
        <!-- Î•Î½ÎµÏÎ³Î® Î²Î¬ÏÎ´Î¹Î± indicator -->
        <div class="shift-indicator" id="active-shift-indicator">
            Î•Ï€Î¹Î»Î­Î¾Ï„Îµ Î²Î¬ÏÎ´Î¹Î± 1 (Ï€Î¬Ï„Î± ÏƒÎµ ÎºÎ¿Ï…Î¼Ï€Î¯ Î³Î¹Î± Î±Î»Î»Î±Î³Î®)
        </div>
        
        <!-- ÎšÎ¿Ï…Î¼Ï€Î¹Î¬ ÎµÏ€Î¹Î»Î¿Î³Î®Ï‚ ÎµÎ½ÎµÏÎ³Î®Ï‚ Î²Î¬ÏÎ´Î¹Î±Ï‚ -->
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; margin-bottom: 10px;">
            <button class="rep-btn-compact shift-select-btn" onclick="setActiveShift(1)" id="shift1-btn">Î’Î¬ÏÎ´Î¹Î± 1</button>
            <button class="rep-btn-compact shift-select-btn" onclick="setActiveShift(2)" id="shift2-btn">Î’Î¬ÏÎ´Î¹Î± 2</button>
            <button class="rep-btn-compact shift-select-btn" onclick="setActiveShift(3)" id="shift3-btn">Î’Î¬ÏÎ´Î¹Î± 3</button>
        </div>
        
        <!-- Î›Î¯ÏƒÏ„Î± Î²Î±ÏÎ´Î¹ÏÎ½ -->
        <div class="m-grid" id="m-opts"></div>
        <hr>
        
        <!-- Î ÎµÎ´Î¯Î± Î²Î±ÏÎ´Î¹ÏÎ½ -->
        <div class="shift-row">
            <input type="text" id="c-n1" placeholder="Î’Î¬ÏÎ´Î¹Î± 1" readonly>
            <input type="number" id="c-h1" placeholder="ÎÏÎµÏ‚" step="0.1" onchange="updateShiftMoney(1)">
            <input type="number" id="c-m1" placeholder="Î Î¿ÏƒÏŒ" readonly>
        </div>
        <div class="shift-row">
            <input type="text" id="c-n2" placeholder="Î’Î¬ÏÎ´Î¹Î± 2" readonly>
            <input type="number" id="c-h2" placeholder="ÎÏÎµÏ‚" step="0.1" onchange="updateShiftMoney(2)">
            <input type="number" id="c-m2" placeholder="Î Î¿ÏƒÏŒ" readonly>
        </div>
        <div id="div-s3" class="shift-row" style="display:none">
            <input type="text" id="c-n3" placeholder="Î’Î¬ÏÎ´Î¹Î± 3" readonly>
            <input type="number" id="c-h3" placeholder="ÎÏÎµÏ‚" step="0.1" onchange="updateShiftMoney(3)">
            <input type="number" id="c-m3" placeholder="Î Î¿ÏƒÏŒ" readonly>
        </div>
        
        <button id="btn-add-3" onclick="showThirdShift()" style="width:100%; padding:10px; margin-bottom:10px; background:#2196f3; color:white; border:none; border-radius:4px; font-weight:bold;">+ 3Î· Î’Î¬ÏÎ´Î¹Î±</button>
        
        <input type="text" id="c-txt" placeholder="Î£Ï‡ÏŒÎ»Î¹Î¿..." style="width:100%; padding:10px; box-sizing:border-box; margin:10px 0;">
        
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px;">
            <button onclick="saveDay()" style="padding:15px; background:var(--green); color:white; border:none; border-radius:4px; font-weight:bold;">Î‘Î ÎŸÎ˜Î—ÎšÎ•Î¥Î£Î—</button>
            <button onclick="deleteDay()" style="padding:15px; background:var(--red); color:white; border:none; border-radius:4px; font-weight:bold;">Î”Î™Î‘Î“Î¡Î‘Î¦Î—</button>
        </div>
        <button onclick="closeModal()" style="width:100%; padding:10px; background:#ccc; border:none; border-radius:4px; font-weight:bold; margin-top:5px;">ÎšÎ›Î•Î™Î£Î™ÎœÎŸ</button>
    </div>
</div>

<script>
let cur = new Date(); 
let db = JSON.parse(localStorage.getItem('exfr_db_v53') || '{}');
let settings = JSON.parse(localStorage.getItem('exfr_settings') || '{"mode":"40"}');
let selD = '';
let activeShift = 1; // 1,2,3 Î³Î¹Î± ÎµÎ½ÎµÏÎ³Î® Î²Î¬ÏÎ´Î¹Î±

// Î‘Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ· Î¼ÎµÏ„Î±Ï†Î¿ÏÎ¬Ï‚ ÏÎµÏ€ÏŒ
let repStorage = JSON.parse(localStorage.getItem('exfr_rep_transfer') || '{"savedTransfers": {}}');

// Î£Ï„Î±Î¸ÎµÏÎ­Ï‚
const NIGHT_RATE = 3.3; // ÎšÎ±Î¸Î±ÏÏŒ Ï€Î¿ÏƒÏŒ Î±Î½Î¬ ÏÏÎ± Î½ÏÏ‡Ï„Î±Ï‚
const PENTHEMERO_GROSS = 46; // ÎœÎµÎ¹ÎºÏ„ÏŒ Î±Î½Î¬ Ï€ÎµÎ½Î¸Î®Î¼ÎµÏÎ¿

function getCurrentMonthKey() {
    return `${cur.getFullYear()}-${String(cur.getMonth() + 1).padStart(2, '0')}`;
}

function getPreviousMonthKey() {
    let prevMonth = new Date(cur.getFullYear(), cur.getMonth() - 1, 1);
    return `${prevMonth.getFullYear()}-${String(prevMonth.getMonth() + 1).padStart(2, '0')}`;
}

const SHIFTS = [
    {n:'Î Î¡Î©Î™', h:8},
    {n:'Î‘Î ÎŸÎ“Î•Î¥ÎœÎ‘', h:8},
    {n:'ÎÎ¥Î§Î¤Î‘', h:8, night:true},
    {n:'Î‘Î”Î™Î‘Î˜Î•Î¤ÎŸ', h:0, abs:true},
    {n:'Î¡Î•Î ÎŸ', h:0, abs:true},
    {n:'ÎŸÎ¦Î•Î™Î›ÎŸÎœÎ•ÎÎŸ Î¡Î•Î ÎŸ', h:8},
    {n:'ÎšÎ‘ÎÎŸÎÎ™ÎšÎ— Î‘Î”Î•Î™Î‘', h:0, abs:true},
    {n:'Î’Î¡Î‘Î§Î•Î™Î‘', h:0, abs:true},
    {n:'Î‘ÎÎ‘Î¡Î¡Î©Î¤Î™ÎšÎ—', h:0, abs:true},
    {n:'Î‘Î™ÎœÎŸÎ”ÎŸÎ¤Î™ÎšÎ—', h:6.8, abs:true},
    {n:'Î•Î™Î”Î™ÎšÎ— Î‘Î”Î•Î™Î‘', h:6.8, abs:true},
    {n:'Î Î•ÎÎ˜Î—ÎœÎ•Î¡ÎŸ', h:0, penthemera:true},
    {n:'Î‘Î¡Î“Î™Î‘ Î ', h:16},
    {n:'Î‘Î¡Î“Î™Î‘ Î‘Î ', h:16},
    {n:'Î‘Î¡Î“Î™Î‘ ÎÎ¥Î§Î¤Î‘', h:16, nightSpecial:true}
];

function fmt(d) { return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`; }

function getHols(y) {
    let h = [fmt(new Date(y,0,1)), fmt(new Date(y,0,6)), fmt(new Date(y,2,25)), fmt(new Date(y,4,1)), fmt(new Date(y,7,15)), fmt(new Date(y,9,16)), fmt(new Date(y,9,28)), fmt(new Date(y,11,25)), fmt(new Date(y,11,26))];
    let a=y%19, d_val=(19*a+15)%30, e_val=(2*(y%4)+4*(y%7)+6*d_val+6)%7;
    let p=d_val+e_val+22+13; let m=3, day=p; if(day>31){day-=31; m=4;} if(day>30){day-=30; m=5;}
    let easter = new Date(y, m-1, day);
    const add = (diff) => { let tmp = new Date(easter); tmp.setDate(tmp.getDate() + diff); h.push(fmt(tmp)); };
    add(-48); add(-2); add(-1); add(0); add(1); add(50); return h;
}

function saveMode() { 
    settings.mode = document.getElementById('mode-sel').value; 
    localStorage.setItem('exfr_settings', JSON.stringify(settings)); 
    calculate(); 
}

function updateWeeklyHours() {
    calculate();
}

function getEffectiveWeeklyHours() {
    let baseHours = parseFloat(document.getElementById('mode-sel').value) || 40;
    let reduced = document.getElementById('reduced-select').value;
    
    if (reduced === 'minus1') {
        return baseHours - 5;
    } else if (reduced === 'minus2') {
        return baseHours - 10;
    }
    return baseHours;
}

function countPenthemera() {
    const y = cur.getFullYear(), m = cur.getMonth();
    const daysInMonth = new Date(y, m + 1, 0).getDate();
    let count = 0;
    
    for (let d = 1; d <= daysInMonth; d++) {
        let dStr = fmt(new Date(y, m, d));
        let dayData = db[dStr];
        
        if (dayData) {
            // ÎˆÎ»ÎµÎ³Ï‡Î¿Ï‚ ÎºÎ±Î¹ Î³Î¹Î± Ï„Î¹Ï‚ 3 Î²Î¬ÏÎ´Î¹ÎµÏ‚
            if (dayData.t1 === 'Î Î•ÎÎ˜Î—ÎœÎ•Î¡ÎŸ') count++;
            if (dayData.t2 === 'Î Î•ÎÎ˜Î—ÎœÎ•Î¡ÎŸ') count++;
            if (dayData.t3 === 'Î Î•ÎÎ˜Î—ÎœÎ•Î¡ÎŸ') count++;
        }
    }
    
    return count;
}

function calculatePenthemera() {
    const count = countPenthemera();
    const gross = count * PENTHEMERO_GROSS;
    const eisfora = gross * 0.02;
    const afterEisfora = gross - eisfora;
    const tax = afterEisfora * 0.20;
    const net = afterEisfora - tax;
    
    document.getElementById('penthemera-count-display').textContent = count;
    document.getElementById('p-count').textContent = count;
    document.getElementById('p-gross').textContent = gross.toFixed(2) + 'â‚¬';
    document.getElementById('p-eis').textContent = eisfora.toFixed(2) + 'â‚¬';
    document.getElementById('p-tax').textContent = tax.toFixed(2) + 'â‚¬';
    document.getElementById('p-net').textContent = net.toFixed(2) + 'â‚¬';
    
    // Î•Î½Î·Î¼Î­ÏÏ‰ÏƒÎ· ÏƒÏ…Î½Î¿Î»Î¹ÎºÎ¿Ï ÎºÎ±Î¸Î±ÏÎ¿Ï
    updateTotalNet();
}

function updateTotalNet() {
    // Î¥Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼ÏŒÏ‚ ÎºÎ±Î¸Î±ÏÏÎ½ Î±Ï€ÏŒ Î½ÏÏ‡Ï„ÎµÏ‚
    const nightHours = parseFloat(document.getElementById('m-night-hours').textContent) || 0;
    const nightNet = nightHours * NIGHT_RATE;
    document.getElementById('night-net').textContent = nightNet.toFixed(2) + 'â‚¬';
    
    // Î¥Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼ÏŒÏ‚ ÎºÎ±Î¸Î±ÏÏÎ½ Î±Ï€ÏŒ Ï€ÎµÎ½Î¸Î®Î¼ÎµÏÎ±
    const penthemeraNetText = document.getElementById('p-net').textContent;
    const penthemeraNet = parseFloat(penthemeraNetText) || 0;
    
    // Î£Ï…Î½Î¿Î»Î¹ÎºÏŒ ÎºÎ±Î¸Î±ÏÏŒ
    const totalNet = nightNet + penthemeraNet;
    document.getElementById('total-net').textContent = totalNet.toFixed(2) + 'â‚¬';
}

function savePaidHours() {
    const paidHours = parseFloat(document.getElementById('paidHours').value) || 0;
    const monthKey = `paid_${cur.getFullYear()}-${cur.getMonth()}`;
    db[monthKey] = paidHours;
    localStorage.setItem('exfr_db_v53', JSON.stringify(db));
    calculateRep();
}

function calculateRep() {
    const HOURS_PER_DAY = 8;
    const currentMonthKey = getCurrentMonthKey();
    const previousMonthKey = getPreviousMonthKey();
    
    const peranHours = parseFloat(document.getElementById('m-peran').textContent) || 0;
    const paidHours = parseFloat(document.getElementById('paidHours').value) || 0;
    
    const synminHours = peranHours - paidHours;
    
    let prminHours = 0;
    if (repStorage.savedTransfers[previousMonthKey]) {
        prminHours = repStorage.savedTransfers[previousMonthKey];
    }
    
    const transferHours = prminHours + synminHours;
    
    // ÎœÎ¿ÏÏ†Î¿Ï€Î¿Î¯Î·ÏƒÎ· Î£Î¥Î/ÎœÎ—Î
    let synminText = "0";
    let synminEl = document.getElementById('synminRep');
    synminEl.classList.remove('negative-value');
    
    if (Math.abs(synminHours) > 0) {
        const isNegative = synminHours < 0;
        const absHours = Math.abs(synminHours);
        const days = Math.floor(absHours / HOURS_PER_DAY);
        const remainingHours = absHours - (days * HOURS_PER_DAY);
        
        if (days > 0) {
            synminText = `${isNegative ? '-' : ''}${days}Ï`;
            if (remainingHours > 0) {
                synminText += ` ${remainingHours.toFixed(1)}Ï‰`;
            }
        } else {
            synminText = `${isNegative ? '-' : ''}${absHours.toFixed(1)}Ï‰`;
        }
        
        if (isNegative) {
            synminEl.classList.add('negative-value');
        }
    }
    synminEl.textContent = synminText;
    
    // Î•Î¼Ï†Î¬Î½Î¹ÏƒÎ· Î Î¡/ÎœÎ—Î
    let prminText = "0";
    let prminEl = document.getElementById('prminRep');
    prminEl.classList.remove('negative-value');
    
    if (Math.abs(prminHours) > 0) {
        const isNegative = prminHours < 0;
        const absHours = Math.abs(prminHours);
        const days = Math.floor(absHours / HOURS_PER_DAY);
        const remainingHours = absHours - (days * HOURS_PER_DAY);
        
        if (days > 0) {
            prminText = `${isNegative ? '-' : ''}${days}Ï`;
            if (remainingHours > 0) {
                prminText += ` ${remainingHours.toFixed(1)}Ï‰`;
            }
        } else {
            prminText = `${isNegative ? '-' : ''}${absHours.toFixed(1)}Ï‰`;
        }
        
        if (isNegative) {
            prminEl.classList.add('negative-value');
        }
    }
    prminEl.textContent = prminText;
    
    // Î•Î¼Ï†Î¬Î½Î¹ÏƒÎ· ÎœÎ•Î¤Î‘Î¦ÎŸÎ¡Î‘Î£
    let transferText = "0";
    let transferEl = document.getElementById('transferRep');
    transferEl.classList.remove('negative-value');
    
    if (Math.abs(transferHours) > 0) {
        const isNegative = transferHours < 0;
        const absTransfer = Math.abs(transferHours);
        const days = Math.floor(absTransfer / HOURS_PER_DAY);
        const remainingHours = absTransfer - (days * HOURS_PER_DAY);
        
        if (days > 0) {
            transferText = `${isNegative ? '-' : ''}${days}Ï`;
            if (remainingHours > 0) {
                transferText += ` ${remainingHours.toFixed(1)}Ï‰`;
            }
        } else {
            transferText = `${isNegative ? '-' : ''}${absTransfer.toFixed(1)}Ï‰`;
        }
        
        if (isNegative) {
            transferEl.classList.add('negative-value');
        }
    }
    transferEl.textContent = transferText;
    
    return {
        synminHours,
        prminHours,
        transferHours,
        currentMonthKey
    };
}

function saveRepTransfer() {
    const result = calculateRep();
    
    if (result.transferHours !== undefined) {
        repStorage.savedTransfers[result.currentMonthKey] = result.transferHours;
        localStorage.setItem('exfr_rep_transfer', JSON.stringify(repStorage));
        showTempMessage("âœ… Î‘Ï€Î¿Î¸Î·ÎºÎµÏÏ„Î·ÎºÎµ Î¼ÎµÏ„Î±Ï†Î¿ÏÎ¬", 2000);
    }
}

function clearRepData() {
    if (confirm("Î•ÎºÎºÎ±Î¸Î¬ÏÎ¹ÏƒÎ· Ï€Î»Î·ÏÏ‰Î¼Î­Î½Ï‰Î½ Ï‰ÏÏÎ½ Ï„ÏÎ­Ï‡Î¿Î½Ï„Î¿Ï‚ Î¼Î®Î½Î±;")) {
        document.getElementById('paidHours').value = 0;
        savePaidHours();
        document.getElementById('transferRep').textContent = "0";
        document.getElementById('transferRep').classList.remove('negative-value');
        calculateRep();
        showTempMessage("âœ… ÎœÎ·Î´ÎµÎ½Î¯ÏƒÏ„Î·ÎºÎ±Î½ Î¿Î¹ Ï€Î»Î·ÏÏ‰Î¼Î­Î½ÎµÏ‚ ÏÏÎµÏ‚", 2000);
    }
}

function showTempMessage(msg, duration) {
    const transferEl = document.getElementById('transferRep');
    const originalText = transferEl.textContent;
    const originalClass = transferEl.className;
    
    transferEl.textContent = msg;
    transferEl.className = "rep-display-compact";
    transferEl.style.background = "#4caf50";
    transferEl.style.color = "white";
    transferEl.style.borderColor = "#388e3c";
    
    setTimeout(() => {
        transferEl.textContent = originalText;
        transferEl.className = originalClass;
        transferEl.style.background = "";
        transferEl.style.color = "";
        transferEl.style.borderColor = "";
    }, duration);
}

function setActiveShift(shift) {
    activeShift = shift;
    
    // Î•Î½Î·Î¼Î­ÏÏ‰ÏƒÎ· indicator
    document.getElementById('active-shift-indicator').textContent = `Î•Ï€Î¹Î»Î­Î¾Ï„Îµ Î²Î¬ÏÎ´Î¹Î± ${shift} (Ï€Î¬Ï„Î± ÏƒÎµ ÎºÎ¿Ï…Î¼Ï€Î¯ Î³Î¹Î± Î±Î»Î»Î±Î³Î®)`;
    
    // Highlight Ï„Î¿ ÎµÎ½ÎµÏÎ³ÏŒ ÎºÎ¿Ï…Î¼Ï€Î¯
    document.querySelectorAll('.shift-select-btn').forEach(btn => btn.classList.remove('active-shift'));
    document.getElementById(`shift${shift}-btn`).classList.add('active-shift');
}

function showThirdShift() {
    document.getElementById('div-s3').style.display = 'grid';
    document.getElementById('btn-add-3').style.display = 'none';
}

function updateShiftMoney(shiftNum) {
    const nameInput = document.getElementById(`c-n${shiftNum}`);
    const hours = parseFloat(document.getElementById(`c-h${shiftNum}`).value) || 0;
    const moneyInput = document.getElementById(`c-m${shiftNum}`);
    
    let money = 0;
    
    if (nameInput.value === 'ÎÎ¥Î§Î¤Î‘') {
        money = hours * NIGHT_RATE;
    } else if (nameInput.value === 'Î‘Î¡Î“Î™Î‘ ÎÎ¥Î§Î¤Î‘') {
        money = 8 * NIGHT_RATE;
    }
    
    moneyInput.value = money.toFixed(2);
}

function selectShift(shiftName, shiftHours, isNight, isNightSpecial, isPenthemera) {
    // Î’ÏÎµÏ‚ Ï€Î¿Î¹Î± Î²Î¬ÏÎ´Î¹Î± ÎµÎ¯Î½Î±Î¹ ÎµÎ½ÎµÏÎ³Î® ÎºÎ±Î¹ ÎµÎ½Î·Î¼Î­ÏÏ‰ÏƒÎ­ Ï„Î·Î½
    const nameInput = document.getElementById(`c-n${activeShift}`);
    const hoursInput = document.getElementById(`c-h${activeShift}`);
    const moneyInput = document.getElementById(`c-m${activeShift}`);
    
    nameInput.value = shiftName;
    hoursInput.value = shiftHours;
    
    // Î‘Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ· attribute
    nameInput.dataset.night = isNight ? "1" : "0";
    nameInput.dataset.nightSpecial = isNightSpecial ? "1" : "0";
    nameInput.dataset.penthemera = isPenthemera ? "1" : "0";
    
    // Î¥Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼ÏŒÏ‚ Ï‡ÏÎ·Î¼Î¬Ï„Ï‰Î½
    let money = 0;
    if (isNight) {
        money = shiftHours * NIGHT_RATE;
    } else if (isNightSpecial) {
        money = 8 * NIGHT_RATE;
    }
    
    moneyInput.value = money.toFixed(2);
    
    // Î‘Ï…Ï„ÏŒÎ¼Î±Ï„Î· Î¼ÎµÏ„Î¬Î²Î±ÏƒÎ· ÏƒÏ„Î·Î½ ÎµÏ€ÏŒÎ¼ÎµÎ½Î· Î²Î¬ÏÎ´Î¹Î± Î±Î½ Î´ÎµÎ½ ÎµÎ¯Î½Î±Î¹ Î· 3Î·
    if (activeShift < 3) {
        setActiveShift(activeShift + 1);
    }
}

function calculate() {
    const y = cur.getFullYear(), m = cur.getMonth(), hols = getHols(y);
    document.getElementById('mode-sel').value = settings.mode;
    document.getElementById('month-label').innerText = new Intl.DateTimeFormat('el-GR', { month: 'short', year: 'numeric' }).format(cur).toUpperCase();
    
    // Î¦ÏŒÏÏ„Ï‰ÏƒÎ· Î±Ï€Î¿Î¸Î·ÎºÎµÏ…Î¼Î­Î½Ï‰Î½ Ï„Î¹Î¼ÏÎ½
    const paidMonthKey = `paid_${y}-${m}`;
    document.getElementById('paidHours').value = db[paidMonthKey] || 0;
    
    document.getElementById('transferRep').textContent = "0";
    document.getElementById('transferRep').classList.remove('negative-value');
    
    let start = (new Date(y, m, 1).getDay() + 6) % 7, days = new Date(y, m + 1, 0).getDate();
    let monthT = 0, monthUPK = 0, monthUPA = 0, totalNightHours = 0;
    let weeks = Array.from({ length: 6 }, () => ({ days: [], target: 0, upk: 0, upa: 0 }));
    
    const weeklyHours = getEffectiveWeeklyHours();
    const dailyHours = weeklyHours / 5; // ÎœÎ¿Î¹ÏÎ¬Î¶Î¿Ï…Î¼Îµ ÏƒÎµ 5 ÎµÏÎ³Î¬ÏƒÎ¹Î¼ÎµÏ‚ Î·Î¼Î­ÏÎµÏ‚
    
    for (let d = 1; d <= days; d++) {
        let dDate = new Date(y, m, d);
        let dStr = fmt(dDate), wIdx = Math.floor((d + start - 1) / 7);
        weeks[wIdx].days.push({ dStr, isH: hols.includes(dStr), dw: dDate.getDay(), s: db[dStr] });
    }
    
    weeks.forEach(w => {
        if (w.days.length === 0) return;
        
        // Î¥Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼ÏŒÏ‚ ÏƒÏ„ÏŒÏ‡Î¿Ï… ÎµÎ²Î´Î¿Î¼Î¬Î´Î±Ï‚ - ÎœÎŸÎÎŸ Î³Î¹Î± ÎµÏÎ³Î¬ÏƒÎ¹Î¼ÎµÏ‚ Î·Î¼Î­ÏÎµÏ‚ (Î”ÎµÏ…Ï„Î­ÏÎ± Î­Ï‰Ï‚ Î Î±ÏÎ±ÏƒÎºÎµÏ…Î®)
        w.target = 0;
        w.days.forEach(day => {
            // Î—Î¼Î­ÏÎµÏ‚ Î”ÎµÏ…Ï„Î­ÏÎ± (1) Î­Ï‰Ï‚ Î Î±ÏÎ±ÏƒÎºÎµÏ…Î® (5)
            if (day.dw >= 1 && day.dw <= 5) {
                w.target += dailyHours;
            }
        });
        
        w.upk = -w.target;
        
        w.days.forEach(day => {
            if (day.s) {
                // Î¥Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼ÏŒÏ‚ Î½Ï…Ï‡Ï„ÎµÏÎ¹Î½ÏÎ½ Ï‰ÏÏÎ½ (Î¼ÏŒÎ½Î¿ Î³Î¹Î± ÎÎ¥Î§Î¤Î‘ ÎºÎ±Î¹ Î‘Î¡Î“Î™Î‘ ÎÎ¥Î§Î¤Î‘)
                if (day.s.night1) totalNightHours += (day.s.h1||0);
                if (day.s.night2) totalNightHours += (day.s.h2||0);
                if (day.s.night3) totalNightHours += (day.s.h3||0);
                
                // Î¥Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼ÏŒÏ‚ Ï‰ÏÏÎ½ Î³Î¹Î± Î¥Î Îš/Î¥Î Î‘ (ÎµÎ¾Î±Î¹ÏÎ¿ÏÎ½Ï„Î±Î¹ Ï„Î± Ï€ÎµÎ½Î¸Î®Î¼ÎµÏÎ±)
                if (!day.s.penthemera1 && !day.s.penthemera2 && !day.s.penthemera3) {
                    let hc = (day.s.h1||0) + (day.s.h2||0) + (day.s.h3||0);
                    
                    for (let i = 0; i < Math.round(hc * 10); i++) {
                        if (w.upk < -0.01) w.upk += 0.1; 
                        else { 
                            if (day.dw === 0 || day.isH) w.upa += 0.1; 
                            else w.upk += 0.1; 
                        }
                    }
                }
            }
        });
        
        monthT += w.target; 
        monthUPK += w.upk; 
        monthUPA += w.upa;
    });
    
    document.getElementById('m-night-hours').innerText = totalNightHours.toFixed(1);
    document.getElementById('m-target').innerText = monthT.toFixed(1);
    document.getElementById('m-upk').innerText = monthUPK.toFixed(1);
    document.getElementById('m-upa').innerText = monthUPA.toFixed(1);
    document.getElementById('m-peran').innerText = (monthUPK + monthUPA).toFixed(1);
    
    // Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± Î·Î¼ÎµÏÎ¿Î»Î¿Î³Î¯Î¿Ï…
    let body = document.getElementById('cal-body'); 
    body.innerHTML = ''; 
    let row = document.createElement('tr');
    
    for (let i = 0; i < start; i++) row.appendChild(document.createElement('td'));
    
    for (let d = 1; d <= days; d++) {
        if (row.children.length === 7) { 
            body.appendChild(row); 
            row = document.createElement('tr'); 
        }
        
        let dStr = fmt(new Date(y, m, d)), s = db[dStr], isH = hols.includes(dStr), dw = new Date(y, m, d).getDay();
        let cell = document.createElement('td'); 
        cell.onclick = () => openModal(dStr);
        
        if (isH) cell.className = 'holiday-cell'; 
        else if (dw === 0) cell.className = 'sun-cell'; 
        else if (dw === 6) cell.className = 'sat-cell';
        
        let tags = ''; 
        if (s) { 
            if(s.t1) tags+=`<div class="shift-tag">${s.t1}</div>`; 
            if(s.t2) tags+=`<div class="shift-tag">${s.t2}</div>`; 
            if(s.t3) tags+=`<div class="shift-tag">${s.t3}</div>`; 
        }
        
        cell.innerHTML = `<span class="day-num">${d}</span>${tags}${s && s.txt ? `<div class="day-note">${s.txt}</div>` : ''}`;
        row.appendChild(cell);
    }
    
    body.appendChild(row);
    
    // Î•Î²Î´Î¿Î¼Î±Î´Î¹Î±Î¯Î± ÏƒÏ„Î±Ï„Î¹ÏƒÏ„Î¹ÎºÎ¬
    const wDiv = document.getElementById('weeks-stats'); 
    wDiv.innerHTML = '';
    
    weeks.forEach((w, i) => { 
        if (w.days.length > 0) {
            wDiv.innerHTML += `
                <div class="w-tile">
                    Î•Î’Î”. ${i+1}<br>
                    Î£Î¤: <span class="w-val">${w.target.toFixed(1)}</span>
                    Î¥Î Îš: <span class="w-val" style="color:var(--blue)">${w.upk.toFixed(1)}</span>
                    Î¥Î Î‘: <span class="w-val" style="color:var(--red)">${w.upa.toFixed(1)}</span>
                </div>
            `;
        }
    });
    
    // Î¥Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼ÏŒÏ‚ Ï€ÎµÎ½Î¸Î·Î¼Î­ÏÏ‰Î½ ÎºÎ±Î¹ ÎµÎ½Î·Î¼Î­ÏÏ‰ÏƒÎ· ÏƒÏ…Î½ÏŒÎ»Ï‰Î½
    calculatePenthemera();
    calculateRep();
    updateTotalNet();
}

function openModal(d) {
    selD = d; 
    let s = db[d] || {};
    
    // Î•Î¼Ï†Î¬Î½Î¹ÏƒÎ· Î·Î¼ÎµÏÎ¿Î¼Î·Î½Î¯Î±Ï‚
    const dateObj = new Date(d);
    const formattedDate = dateObj.toLocaleDateString('el-GR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
    document.getElementById('modal-date').textContent = formattedDate;
    
    // Î¦ÏŒÏÏ„Ï‰ÏƒÎ· Î´ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½
    document.getElementById('c-n1').value = s.t1 || ''; 
    document.getElementById('c-h1').value = s.h1 || ''; 
    document.getElementById('c-m1').value = s.m1 || '';
    document.getElementById('c-n1').dataset.night = s.night1 ? "1" : "0";
    document.getElementById('c-n1').dataset.penthemera = s.penthemera1 ? "1" : "0";
    
    document.getElementById('c-n2').value = s.t2 || ''; 
    document.getElementById('c-h2').value = s.h2 || ''; 
    document.getElementById('c-m2').value = s.m2 || '';
    document.getElementById('c-n2').dataset.night = s.night2 ? "1" : "0";
    document.getElementById('c-n2').dataset.penthemera = s.penthemera2 ? "1" : "0";
    
    document.getElementById('c-n3').value = s.t3 || ''; 
    document.getElementById('c-h3').value = s.h3 || ''; 
    document.getElementById('c-m3').value = s.m3 || '';
    document.getElementById('c-n3').dataset.night = s.night3 ? "1" : "0";
    document.getElementById('c-n3').dataset.penthemera = s.penthemera3 ? "1" : "0";
    
    if (s.t3) {
        document.getElementById('div-s3').style.display = 'grid';
        document.getElementById('btn-add-3').style.display = 'none';
    } else {
        document.getElementById('div-s3').style.display = 'none';
        document.getElementById('btn-add-3').style.display = 'block';
    }
    
    document.getElementById('c-txt').value = s.txt || '';
    
    // Î‘ÏÏ‡Î¹ÎºÎ¿Ï€Î¿Î¯Î·ÏƒÎ· ÎµÎ½ÎµÏÎ³Î®Ï‚ Î²Î¬ÏÎ´Î¹Î±Ï‚
    setActiveShift(1);
    
    // Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± ÎºÎ¿Ï…Î¼Ï€Î¹ÏÎ½ Î²Î±ÏÎ´Î¹ÏÎ½
    renderShifts();
    
    document.getElementById('modal').style.display = 'block';
}

function renderShifts() {
    const grid = document.getElementById('m-opts'); 
    grid.innerHTML = '';
    
    SHIFTS.forEach(o => {
        let b = document.createElement('div'); 
        b.className = 'm-btn';
        
        let description = o.n;
        if (o.night) description += ` (${NIGHT_RATE}â‚¬/ÏÏÎ±)`;
        if (o.nightSpecial) description += ` (8Ï‰ ${NIGHT_RATE}â‚¬/ÏÏÎ±)`;
        
        b.innerHTML = `<span>${description}</span>`;
        b.onclick = () => selectShift(o.n, o.h, o.night || false, o.nightSpecial || false, o.penthemera || false);
        grid.appendChild(b);
    });
}

function saveDay() {
    const s = {
        t1: document.getElementById('c-n1').value, 
        h1: parseFloat(document.getElementById('c-h1').value) || 0, 
        m1: parseFloat(document.getElementById('c-m1').value) || 0,
        night1: document.getElementById('c-n1').dataset.night === "1",
        penthemera1: document.getElementById('c-n1').value === 'Î Î•ÎÎ˜Î—ÎœÎ•Î¡ÎŸ',
        t2: document.getElementById('c-n2').value, 
        h2: parseFloat(document.getElementById('c-h2').value) || 0, 
        m2: parseFloat(document.getElementById('c-m2').value) || 0,
        night2: document.getElementById('c-n2').dataset.night === "1",
        penthemera2: document.getElementById('c-n2').value === 'Î Î•ÎÎ˜Î—ÎœÎ•Î¡ÎŸ',
        t3: document.getElementById('c-n3').value, 
        h3: parseFloat(document.getElementById('c-h3').value) || 0, 
        m3: parseFloat(document.getElementById('c-m3').value) || 0,
        night3: document.getElementById('c-n3').dataset.night === "1",
        penthemera3: document.getElementById('c-n3').value === 'Î Î•ÎÎ˜Î—ÎœÎ•Î¡ÎŸ',
        txt: document.getElementById('c-txt').value
    };
    
    // ÎˆÎ»ÎµÎ³Ï‡Î¿Ï‚ Î±Î½ ÎµÎ¯Î½Î±Î¹ Î±Ï€Î¿ÏÏƒÎ± (Î³Î¹Î± abs calculation)
    s.abs = SHIFTS.find(x => x.n === s.t1)?.abs || SHIFTS.find(x => x.n === s.t2)?.abs || SHIFTS.find(x => x.n === s.t3)?.abs || false;
    
    db[selD] = s; 
    localStorage.setItem('exfr_db_v53', JSON.stringify(db)); 
    closeModal(); 
    calculate();
}

function deleteDay() {
    if (confirm("Î”Î¹Î±Î³ÏÎ±Ï†Î® Î·Î¼Î­ÏÎ±Ï‚;")) {
        delete db[selD];
        localStorage.setItem('exfr_db_v53', JSON.stringify(db));
        closeModal();
        calculate();
    }
}

function closeModal() { 
    document.getElementById('modal').style.display = 'none'; 
}

function nav(v) { 
    cur.setMonth(cur.getMonth() + v); 
    calculate(); 
}

function exportData() {
    const data = JSON.stringify({ db, settings, repStorage });
    const fileName = `exfr_backup_${new Date().getTime()}.json`;

    if (window.cordova && cordova.file) {
        const path = cordova.file.externalRootDirectory + "Download/";
        window.resolveLocalFileSystemURL(path, (dir) => {
            dir.getFile(fileName, { create: true }, (fileEntry) => {
                fileEntry.createWriter((fileWriter) => {
                    fileWriter.onwriteend = () => alert("âœ… Î¤Î¿ Î±ÏÏ‡ÎµÎ¯Î¿ Î±Ï€Î¿Î¸Î·ÎºÎµÏÏ„Î·ÎºÎµ ÏƒÏ„Î¿ Ï†Î¬ÎºÎµÎ»Î¿ Downloads!");
                    fileWriter.onerror = (e) => alert("âŒ Î£Ï†Î¬Î»Î¼Î± ÎµÎ³Î³ÏÎ±Ï†Î®Ï‚: " + e.toString());
                    fileWriter.write(new Blob([data], { type: 'application/json' }));
                });
            });
        }, (err) => alert("âŒ Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎµ Î¿ Ï†Î¬ÎºÎµÎ»Î¿Ï‚ Downloads. Î”ÏÏƒÏ„Îµ Î´Î¹ÎºÎ±Î¹ÏÎ¼Î±Ï„Î± Î±ÏÏ‡ÎµÎ¯Ï‰Î½."));
    } else {
        const blob = new Blob([data], { type: 'application/json' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = fileName;
        a.click();
    }
}

function importData(e) {
    const file = e.target.files[0]; if (!file) return;
    const reader = new FileReader();
    reader.onload = (event) => {
        try {
            const data = JSON.parse(event.target.result);
            if (data.db) {
                db = data.db; 
                settings = data.settings || settings;
                repStorage = data.repStorage || {"savedTransfers": {}};
                
                localStorage.setItem('exfr_db_v53', JSON.stringify(db));
                localStorage.setItem('exfr_settings', JSON.stringify(settings));
                localStorage.setItem('exfr_rep_transfer', JSON.stringify(repStorage));
                
                alert("âœ… Î¤Î¿ Backup Ï†Î¿ÏÏ„ÏÎ¸Î·ÎºÎµ!"); 
                location.reload();
            }
        } catch(err) { alert("âŒ Î¤Î¿ Î±ÏÏ‡ÎµÎ¯Î¿ Î´ÎµÎ½ ÎµÎ¯Î½Î±Î¹ Î­Î³ÎºÏ…ÏÎ¿."); }
    };
    reader.readAsText(file);
}

// Î‘ÏÏ‡Î¹ÎºÎ¿Ï€Î¿Î¯Î·ÏƒÎ·
document.addEventListener('DOMContentLoaded', function() {
    const savedRep = localStorage.getItem('exfr_rep_transfer');
    if (savedRep) {
        try {
            repStorage = JSON.parse(savedRep);
            if (!repStorage.savedTransfers) {
                repStorage.savedTransfers = {};
            }
        } catch(e) {
            repStorage = {"savedTransfers": {}};
        }
    } else {
        repStorage = {"savedTransfers": {}};
    }
    
    setTimeout(function() {
        calculate();
    }, 100);
});

document.addEventListener('deviceready', calculate, false);
if(!window.cordova) calculate();
</script>
</body>
</html>
